/**
 * Vulnerability types for Container Analysis API integration.
 * @module types/vulnerability
 */

import { z } from 'zod';
import type { Timestamp } from './common.js';

/**
 * Vulnerability severity levels.
 */
export type Severity =
  | 'SEVERITY_UNSPECIFIED'
  | 'MINIMAL'
  | 'LOW'
  | 'MEDIUM'
  | 'HIGH'
  | 'CRITICAL';

/**
 * Severity enum for ordering.
 */
export const SeverityOrder: Record<Severity, number> = {
  SEVERITY_UNSPECIFIED: 0,
  MINIMAL: 1,
  LOW: 2,
  MEDIUM: 3,
  HIGH: 4,
  CRITICAL: 5,
};

/**
 * Occurrence kind types.
 */
export type OccurrenceKind =
  | 'NOTE_KIND_UNSPECIFIED'
  | 'VULNERABILITY'
  | 'BUILD'
  | 'IMAGE'
  | 'PACKAGE'
  | 'DEPLOYMENT'
  | 'DISCOVERY'
  | 'ATTESTATION'
  | 'UPGRADE'
  | 'COMPLIANCE'
  | 'DSSE_ATTESTATION'
  | 'SBOM_REFERENCE';

/**
 * Package issue from vulnerability scan.
 */
export interface PackageIssue {
  /** Affected package name */
  affectedPackage: string;
  /** Affected CPE URI */
  affectedCpeUri?: string;
  /** Affected version */
  affectedVersion?: PackageVersion;
  /** Fixed CPE URI */
  fixedCpeUri?: string;
  /** Fixed version */
  fixedVersion?: PackageVersion;
  /** Whether a fix is available */
  fixAvailable: boolean;
  /** Package type */
  packageType?: string;
  /** Effective severity (may differ from note severity) */
  effectiveSeverity?: Severity;
}

/**
 * Package version information.
 */
export interface PackageVersion {
  /** Version string */
  name?: string;
  /** Version kind */
  kind?: 'VERSION_KIND_UNSPECIFIED' | 'NORMAL' | 'MINIMUM' | 'MAXIMUM';
  /** Full name including epoch/revision */
  fullName?: string;
}

/**
 * CVSS (Common Vulnerability Scoring System) information.
 */
export interface CVSS {
  /** Base score (0-10) */
  baseScore: number;
  /** Attack vector */
  attackVector?: string;
  /** Attack complexity */
  attackComplexity?: string;
  /** Privileges required */
  privilegesRequired?: string;
  /** User interaction */
  userInteraction?: string;
  /** Scope */
  scope?: string;
  /** Confidentiality impact */
  confidentialityImpact?: string;
  /** Integrity impact */
  integrityImpact?: string;
  /** Availability impact */
  availabilityImpact?: string;
}

/**
 * Related URL.
 */
export interface RelatedUrl {
  /** URL */
  url: string;
  /** Label/description */
  label?: string;
}

/**
 * Vulnerability details from an occurrence.
 */
export interface VulnerabilityDetails {
  /** Vulnerability type */
  type?: string;
  /** Severity */
  severity: Severity;
  /** CVSS score */
  cvssScore?: number;
  /** CVSS v3 details */
  cvssV3?: CVSS;
  /** Package issues */
  packageIssue: PackageIssue[];
  /** Short description (CVE ID) */
  shortDescription?: string;
  /** Long description */
  longDescription?: string;
  /** Related URLs */
  relatedUrls?: RelatedUrl[];
  /** Effective severity */
  effectiveSeverity?: Severity;
  /** Whether a fix is available */
  fixAvailable?: boolean;
}

/**
 * Discovery details for scan status.
 */
export interface DiscoveryDetails {
  /** Analysis status */
  analysisStatus:
    | 'ANALYSIS_STATUS_UNSPECIFIED'
    | 'PENDING'
    | 'SCANNING'
    | 'FINISHED_SUCCESS'
    | 'FINISHED_FAILED'
    | 'FINISHED_UNSUPPORTED';
  /** Analysis status error */
  analysisStatusError?: {
    code: number;
    message: string;
  };
  /** Continuous analysis */
  continuousAnalysis?: 'CONTINUOUS_ANALYSIS_UNSPECIFIED' | 'ACTIVE' | 'INACTIVE';
  /** Last scan time */
  lastScanTime?: Timestamp;
}

/**
 * SBOM reference details.
 */
export interface SbomReferenceDetails {
  /** Payload */
  payload: {
    /** SBOM URI */
    sbomUri: string;
    /** SBOM format */
    format?: string;
  };
}

/**
 * Occurrence from Container Analysis API.
 */
export interface Occurrence {
  /** Occurrence name */
  name: string;
  /** Resource URI this occurrence applies to */
  resourceUri: string;
  /** Note name this occurrence is an instance of */
  noteName: string;
  /** Occurrence kind */
  kind: OccurrenceKind;
  /** Creation timestamp */
  createTime: Timestamp;
  /** Update timestamp */
  updateTime: Timestamp;
  /** Vulnerability details (if kind is VULNERABILITY) */
  vulnerability?: VulnerabilityDetails;
  /** Discovery details (if kind is DISCOVERY) */
  discovery?: DiscoveryDetails;
  /** SBOM reference details (if kind is SBOM_REFERENCE) */
  sbomReference?: SbomReferenceDetails;
}

/**
 * List occurrences response.
 */
export interface ListOccurrencesResponse {
  /** Occurrences */
  occurrences: Occurrence[];
  /** Next page token */
  nextPageToken?: string;
}

/**
 * Note from Container Analysis API.
 */
export interface Note {
  /** Note name */
  name: string;
  /** Short description */
  shortDescription?: string;
  /** Long description */
  longDescription?: string;
  /** Note kind */
  kind: OccurrenceKind;
  /** Related URLs */
  relatedUrl?: RelatedUrl[];
  /** Creation timestamp */
  createTime: Timestamp;
  /** Update timestamp */
  updateTime: Timestamp;
}

/**
 * List notes response.
 */
export interface ListNotesResponse {
  /** Notes */
  notes: Note[];
  /** Next page token */
  nextPageToken?: string;
}

/**
 * Vulnerability summary by severity.
 */
export interface VulnerabilitySummary {
  /** Counts by severity */
  counts: SeverityCount[];
}

/**
 * Count for a specific severity.
 */
export interface SeverityCount {
  /** Severity level */
  severity: Severity;
  /** Number of vulnerabilities */
  count: number;
  /** Fix available count */
  fixableCount?: number;
}

/**
 * Aggregated vulnerability report for an image.
 */
export interface VulnerabilityReport {
  /** Total vulnerability count */
  totalCount: number;
  /** Counts by severity */
  severityCounts: Record<Severity, number>;
  /** Individual vulnerabilities */
  vulnerabilities: Vulnerability[];
  /** Scan timestamp */
  scanTime?: Timestamp;
}

/**
 * Individual vulnerability information.
 */
export interface Vulnerability {
  /** CVE ID (e.g., "CVE-2021-44228") */
  cveId?: string;
  /** Severity */
  severity: Severity;
  /** CVSS score */
  cvssScore?: number;
  /** Affected package name */
  packageName: string;
  /** Installed version */
  installedVersion?: string;
  /** Fixed version (if available) */
  fixedVersion?: string;
  /** Whether a fix is available */
  fixAvailable: boolean;
  /** Description */
  description?: string;
  /** URL for more information */
  url?: string;
}

/**
 * Scan status for an image.
 */
export type ScanStatus =
  | { status: 'NOT_SCANNED' }
  | { status: 'SCANNING' }
  | { status: 'COMPLETED'; timestamp: Timestamp }
  | { status: 'FAILED'; reason: string };

/**
 * Zod schema for Severity validation.
 */
export const SeveritySchema = z.enum([
  'SEVERITY_UNSPECIFIED',
  'MINIMAL',
  'LOW',
  'MEDIUM',
  'HIGH',
  'CRITICAL',
]);

/**
 * Zod schema for Occurrence validation.
 */
export const OccurrenceSchema = z.object({
  name: z.string(),
  resourceUri: z.string(),
  noteName: z.string(),
  kind: z.string(),
  createTime: z.string(),
  updateTime: z.string(),
  vulnerability: z.any().optional(),
  discovery: z.any().optional(),
  sbomReference: z.any().optional(),
});

/**
 * Builds a vulnerability report from occurrences.
 */
export function buildVulnerabilityReport(
  occurrences: Occurrence[]
): VulnerabilityReport {
  const vulnerabilities: Vulnerability[] = [];
  const severityCounts: Record<Severity, number> = {
    SEVERITY_UNSPECIFIED: 0,
    MINIMAL: 0,
    LOW: 0,
    MEDIUM: 0,
    HIGH: 0,
    CRITICAL: 0,
  };

  let scanTime: Timestamp | undefined;

  for (const occurrence of occurrences) {
    if (occurrence.kind !== 'VULNERABILITY' || !occurrence.vulnerability) {
      continue;
    }

    const vuln = occurrence.vulnerability;
    const severity = vuln.effectiveSeverity || vuln.severity;
    severityCounts[severity]++;

    for (const pkg of vuln.packageIssue) {
      vulnerabilities.push({
        cveId: vuln.shortDescription,
        severity,
        cvssScore: vuln.cvssScore,
        packageName: pkg.affectedPackage,
        installedVersion: pkg.affectedVersion?.fullName || pkg.affectedVersion?.name,
        fixedVersion: pkg.fixedVersion?.fullName || pkg.fixedVersion?.name,
        fixAvailable: pkg.fixAvailable,
        description: vuln.longDescription,
        url: vuln.relatedUrls?.[0]?.url,
      });
    }

    if (!scanTime || occurrence.createTime > scanTime) {
      scanTime = occurrence.createTime;
    }
  }

  return {
    totalCount: vulnerabilities.length,
    severityCounts,
    vulnerabilities,
    scanTime,
  };
}

/**
 * Sorts vulnerabilities by severity (highest first).
 */
export function sortBySeverity(vulnerabilities: Vulnerability[]): Vulnerability[] {
  return [...vulnerabilities].sort(
    (a, b) => SeverityOrder[b.severity] - SeverityOrder[a.severity]
  );
}

/**
 * Filters vulnerabilities by minimum severity.
 */
export function filterBySeverity(
  vulnerabilities: Vulnerability[],
  minSeverity: Severity
): Vulnerability[] {
  const minOrder = SeverityOrder[minSeverity];
  return vulnerabilities.filter(v => SeverityOrder[v.severity] >= minOrder);
}

/**
 * Filters vulnerabilities that have fixes available.
 */
export function filterFixable(vulnerabilities: Vulnerability[]): Vulnerability[] {
  return vulnerabilities.filter(v => v.fixAvailable);
}
