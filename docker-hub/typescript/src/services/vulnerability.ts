/**
 * Vulnerability Service for Docker Hub integration following SPARC specification.
 *
 * Handles Docker Hub vulnerability scan data for container images.
 * Provides access to scan results and vulnerability summaries.
 *
 * @module services/vulnerability
 */

import { AuthManager } from '../auth/index.js';
import { DockerHubError, DockerHubErrorKind } from '../errors.js';
import {
  ScanOverview,
  ScanStatus,
  VulnerabilitySummary,
  validateNamespace,
  validateRepositoryName,
  validateDigest,
} from '../types/index.js';

// ============================================================================
// DockerHubClient Interface
// ============================================================================

/**
 * Minimal DockerHubClient interface required by VulnerabilityService.
 * This interface defines the HTTP request capabilities needed.
 */
export interface DockerHubClient {
  /**
   * Performs an authenticated GET request to the Hub API.
   *
   * @param path - API endpoint path
   * @param options - Optional request configuration
   * @returns Promise resolving to the response data
   */
  get<T>(path: string, options?: RequestOptions): Promise<T>;

  /**
   * Gets the authentication manager for token handling.
   */
  readonly authManager: AuthManager;

  /**
   * Gets the Hub API base URL.
   */
  readonly hubUrl: string;
}

/**
 * Request options for HTTP calls.
 */
export interface RequestOptions {
  /** Query parameters */
  query?: Record<string, string>;
  /** Additional headers */
  headers?: Record<string, string>;
  /** Request timeout in milliseconds */
  timeout?: number;
}

// ============================================================================
// API Response Types
// ============================================================================

/**
 * Raw API response for vulnerability scan from Docker Hub.
 * Maps to the actual Hub API response structure.
 */
interface VulnerabilityScanResponse {
  /** Scan status string */
  status?: string;
  /** Last scan timestamp (ISO 8601) */
  last_scanned?: string;
  /** Vulnerability summary by severity */
  summary?: {
    critical?: number;
    high?: number;
    medium?: number;
    low?: number;
    unknown?: number;
  };
}

// ============================================================================
// Service Interface
// ============================================================================

/**
 * Vulnerability service interface.
 * Provides access to vulnerability scan data for Docker Hub images.
 */
export interface VulnerabilityService {
  /**
   * Gets the vulnerability scan overview for a specific image.
   *
   * @param namespace - Repository namespace (username or organization)
   * @param repo - Repository name
   * @param digest - Image digest (sha256:...)
   * @returns Promise resolving to the scan overview
   * @throws {DockerHubError} If validation fails or API request fails
   *
   * @example
   * ```typescript
   * const overview = await vulnerabilityService.getScanOverview(
   *   'library',
   *   'nginx',
   *   'sha256:abc123...'
   * );
   * console.log(`Status: ${overview.scanStatus}`);
   * console.log(`Critical: ${overview.vulnerabilitySummary.critical}`);
   * ```
   */
  getScanOverview(
    namespace: string,
    repo: string,
    digest: string
  ): Promise<ScanOverview>;
}

// ============================================================================
// Service Implementation
// ============================================================================

/**
 * Implementation of the VulnerabilityService.
 *
 * Communicates with Docker Hub API to retrieve vulnerability scan results
 * for container images. Handles authentication via JWT tokens and maps
 * API responses to the ScanOverview type.
 */
export class VulnerabilityServiceImpl implements VulnerabilityService {
  private readonly client: DockerHubClient;

  /**
   * Creates a new VulnerabilityService instance.
   *
   * @param client - DockerHubClient instance for API communication
   */
  constructor(client: DockerHubClient) {
    this.client = client;
  }

  /**
   * Gets the vulnerability scan overview for a specific image.
   *
   * @param namespace - Repository namespace (username or organization)
   * @param repo - Repository name
   * @param digest - Image digest (sha256:...)
   * @returns Promise resolving to the scan overview
   * @throws {DockerHubError} If validation fails or API request fails
   */
  async getScanOverview(
    namespace: string,
    repo: string,
    digest: string
  ): Promise<ScanOverview> {
    // Validate inputs
    this.validateInputs(namespace, repo, digest);

    // Build API endpoint path
    // Format: /v2/repositories/{namespace}/{repo}/images/{digest}/vulnerabilities
    const path = `/v2/repositories/${encodeURIComponent(namespace)}/${encodeURIComponent(repo)}/images/${encodeURIComponent(digest)}/vulnerabilities`;

    try {
      // Perform authenticated request to Hub API
      const response = await this.client.get<VulnerabilityScanResponse>(path);

      // Map API response to ScanOverview
      return this.mapResponse(response);
    } catch (error) {
      // Handle 404 as "not scanned" rather than an error
      if (this.isNotFoundError(error)) {
        return this.createNotScannedOverview();
      }

      // Re-throw other errors
      throw this.handleError(error, namespace, repo, digest);
    }
  }

  // ============================================================================
  // Private Helper Methods
  // ============================================================================

  /**
   * Validates input parameters.
   *
   * @param namespace - Repository namespace
   * @param repo - Repository name
   * @param digest - Image digest
   * @throws {DockerHubError} If validation fails
   */
  private validateInputs(
    namespace: string,
    repo: string,
    digest: string
  ): void {
    try {
      validateNamespace(namespace);
    } catch (error) {
      throw new DockerHubError(
        DockerHubErrorKind.InvalidNamespace,
        `Invalid namespace: ${(error as Error).message}`,
        { cause: error as Error }
      );
    }

    try {
      validateRepositoryName(repo);
    } catch (error) {
      throw new DockerHubError(
        DockerHubErrorKind.RepositoryNameInvalid,
        `Invalid repository name: ${(error as Error).message}`,
        { cause: error as Error }
      );
    }

    try {
      validateDigest(digest);
    } catch (error) {
      throw new DockerHubError(
        DockerHubErrorKind.ManifestInvalid,
        `Invalid digest: ${(error as Error).message}`,
        { cause: error as Error }
      );
    }
  }

  /**
   * Maps API response to ScanOverview type.
   *
   * @param response - Raw API response
   * @returns Mapped ScanOverview object
   */
  private mapResponse(response: VulnerabilityScanResponse): ScanOverview {
    // Parse scan status
    const scanStatus = this.parseScanStatus(response.status);

    // Parse last scanned timestamp
    const lastScanned = response.last_scanned
      ? new Date(response.last_scanned)
      : undefined;

    // Build vulnerability summary with defaults
    const vulnerabilitySummary: VulnerabilitySummary = {
      critical: response.summary?.critical ?? 0,
      high: response.summary?.high ?? 0,
      medium: response.summary?.medium ?? 0,
      low: response.summary?.low ?? 0,
      unknown: response.summary?.unknown ?? 0,
    };

    return {
      scanStatus,
      lastScanned,
      vulnerabilitySummary,
    };
  }

  /**
   * Parses scan status string from API response.
   *
   * @param status - Status string from API
   * @returns Parsed ScanStatus
   */
  private parseScanStatus(status?: string): ScanStatus {
    if (!status) {
      return 'not_scanned';
    }

    const normalized = status.toLowerCase().trim();

    switch (normalized) {
      case 'pending':
        return 'pending';
      case 'scanning':
      case 'in_progress':
        return 'scanning';
      case 'completed':
      case 'complete':
      case 'success':
        return 'completed';
      case 'failed':
      case 'error':
        return 'failed';
      case 'not_scanned':
      case 'none':
        return 'not_scanned';
      default:
        // Unknown status defaults to not_scanned
        return 'not_scanned';
    }
  }

  /**
   * Creates a ScanOverview for images that haven't been scanned.
   *
   * @returns ScanOverview with not_scanned status
   */
  private createNotScannedOverview(): ScanOverview {
    return {
      scanStatus: 'not_scanned',
      lastScanned: undefined,
      vulnerabilitySummary: {
        critical: 0,
        high: 0,
        medium: 0,
        low: 0,
        unknown: 0,
      },
    };
  }

  /**
   * Checks if an error is a 404 Not Found error.
   *
   * @param error - Error to check
   * @returns True if error is 404
   */
  private isNotFoundError(error: unknown): boolean {
    if (error instanceof DockerHubError) {
      return (
        error.statusCode === 404 ||
        error.kind === DockerHubErrorKind.ManifestNotFound ||
        error.kind === DockerHubErrorKind.RepositoryNotFound
      );
    }

    // Check for raw HTTP errors
    if (error && typeof error === 'object' && 'status' in error) {
      return (error as { status: number }).status === 404;
    }

    return false;
  }

  /**
   * Handles and wraps errors from API calls.
   *
   * @param error - Original error
   * @param namespace - Repository namespace (for context)
   * @param repo - Repository name (for context)
   * @param digest - Image digest (for context)
   * @returns Wrapped DockerHubError
   */
  private handleError(
    error: unknown,
    namespace: string,
    repo: string,
    digest: string
  ): DockerHubError {
    // Already a DockerHubError, return as-is
    if (error instanceof DockerHubError) {
      return error;
    }

    // Network/timeout errors
    if (error instanceof TypeError && error.message.includes('fetch')) {
      return new DockerHubError(
        DockerHubErrorKind.ConnectionFailed,
        `Failed to connect to Docker Hub API: ${error.message}`,
        { cause: error }
      );
    }

    // Generic error wrapping
    const message = error instanceof Error ? error.message : String(error);
    return new DockerHubError(
      DockerHubErrorKind.Unknown,
      `Failed to get vulnerability scan for ${namespace}/${repo}@${digest}: ${message}`,
      { cause: error instanceof Error ? error : undefined }
    );
  }
}

// ============================================================================
// Factory Function
// ============================================================================

/**
 * Creates a new VulnerabilityService instance.
 *
 * @param client - DockerHubClient instance
 * @returns VulnerabilityService implementation
 *
 * @example
 * ```typescript
 * const vulnerabilityService = createVulnerabilityService(dockerHubClient);
 * const overview = await vulnerabilityService.getScanOverview(
 *   'library',
 *   'nginx',
 *   'sha256:abc123...'
 * );
 * ```
 */
export function createVulnerabilityService(
  client: DockerHubClient
): VulnerabilityService {
  return new VulnerabilityServiceImpl(client);
}

// ============================================================================
// Exports
// ============================================================================

export default VulnerabilityServiceImpl;
