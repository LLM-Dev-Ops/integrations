# Azure Files Integration Module - Architecture

**SPARC Phase 3: Architecture**
**Version:** 1.0.0
**Date:** 2025-12-13
**Module:** `integrations/azure-files`

---

## 1. Module Structure

### 1.1 Directory Layout

```
integrations/azure-files/
├── Cargo.toml
├── src/
│   ├── lib.rs                  # Public API exports
│   ├── client.rs               # AzureFilesClient, builder
│   ├── config.rs               # Configuration types
│   ├── services/
│   │   ├── mod.rs
│   │   ├── files.rs            # FileService
│   │   ├── directories.rs      # DirectoryService
│   │   ├── leases.rs           # LeaseService
│   │   └── shares.rs           # ShareService
│   ├── streaming/
│   │   ├── mod.rs
│   │   ├── upload.rs           # Streaming upload
│   │   └── download.rs         # Streaming download
│   ├── auth/
│   │   ├── mod.rs
│   │   ├── shared_key.rs       # Shared key signing
│   │   └── sas.rs              # SAS token handling
│   ├── transport/
│   │   ├── mod.rs
│   │   └── http.rs             # HTTP client
│   ├── types/
│   │   ├── mod.rs
│   │   ├── requests.rs         # Request types
│   │   ├── responses.rs        # Response types
│   │   └── properties.rs       # File/directory properties
│   ├── simulation/
│   │   ├── mod.rs
│   │   ├── mock.rs             # In-memory mock
│   │   ├── recorder.rs         # Recording client
│   │   └── replayer.rs         # Replay client
│   └── errors.rs               # Error types
└── tests/
    ├── unit/
    ├── integration/
    └── simulation/
```

### 1.2 Module Dependencies

```
┌─────────────────────────────────────────────────────────────┐
│                         lib.rs                               │
│                     (Public Exports)                         │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
    ┌──────────┐        ┌──────────┐        ┌──────────┐
    │  client  │        │ services │        │  types   │
    └──────────┘        └──────────┘        └──────────┘
          │                   │                   │
          │      ┌────────────┼────────────┐      │
          │      ▼            ▼            ▼      │
          │ ┌────────┐  ┌────────┐  ┌────────┐   │
          │ │ files  │  │  dirs  │  │ leases │   │
          │ └────────┘  └────────┘  └────────┘   │
          │      │            │            │      │
          │      └────────────┼────────────┘      │
          │                   ▼                   │
          │            ┌───────────┐              │
          │            │ streaming │              │
          │            └───────────┘              │
          │                   │                   │
          ▼                   ▼                   ▼
    ┌──────────┐        ┌──────────┐        ┌──────────┐
    │   auth   │        │transport │        │simulation│
    └──────────┘        └──────────┘        └──────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              ▼
                       ┌──────────┐
                       │  errors  │
                       └──────────┘
```

---

## 2. Component Architecture

### 2.1 Client Layer

```
┌─────────────────────────────────────────────────────────────┐
│                     AzureFilesClient                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ FileService │  │  DirService │  │LeaseService │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│  ┌──────┴────────────────┴────────────────┴──────┐         │
│  │              StreamingService                  │         │
│  └────────────────────────────────────────────────┘         │
│         │                │                │                 │
│  ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐         │
│  │    Auth     │  │  Transport  │  │CircuitBreaker│        │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │     Azure Files REST API      │
              └───────────────────────────────┘
```

### 2.2 Service Interfaces

```
┌─────────────────────────────────────────────────────────────┐
│                  «trait» FileServiceTrait                    │
├─────────────────────────────────────────────────────────────┤
│ + create(req: CreateFileRequest) -> Result<FileInfo>        │
│ + read(req: ReadFileRequest) -> Result<FileContent>         │
│ + write(req: WriteFileRequest) -> Result<()>                │
│ + delete(req: DeleteFileRequest) -> Result<()>              │
│ + get_properties(req) -> Result<FileProperties>             │
│ + set_metadata(req) -> Result<()>                           │
└─────────────────────────────────────────────────────────────┘
                              △
              ┌───────────────┴───────────────┐
              │                               │
    ┌─────────┴─────────┐          ┌─────────┴─────────┐
    │   FileService     │          │  MockFileService  │
    │   (Production)    │          │    (Testing)      │
    └───────────────────┘          └───────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  «trait» LeaseServiceTrait                   │
├─────────────────────────────────────────────────────────────┤
│ + acquire(req: AcquireLeaseRequest) -> Result<Lease>        │
│ + renew(lease: &Lease) -> Result<()>                        │
│ + release(lease: Lease) -> Result<()>                       │
│ + break_lease(req: BreakLeaseRequest) -> Result<Duration>   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                «trait» StreamingServiceTrait                 │
├─────────────────────────────────────────────────────────────┤
│ + upload_stream(req, stream) -> Result<FileInfo>            │
│ + download_stream(req) -> Result<ByteStream>                │
│ + download_range(req) -> Result<Bytes>                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Data Flow Diagrams

### 3.1 File Write Flow

```
┌──────────┐     ┌───────────┐     ┌───────────────┐
│  Caller  │────▶│FileService│────▶│ Size Check    │
└──────────┘     └───────────┘     └───────┬───────┘
                                           │
                      ┌────────────────────┴────────────────────┐
                      ▼                                         ▼
               ┌─────────────┐                          ┌─────────────┐
               │  < 4 MB     │                          │  >= 4 MB    │
               │Single Range │                          │  Chunked    │
               └──────┬──────┘                          └──────┬──────┘
                      │                                        │
                      │                           ┌────────────┴────────────┐
                      │                           ▼            ▼            ▼
                      │                     ┌─────────┐  ┌─────────┐  ┌─────────┐
                      │                     │Range 0-4│  │Range 4-8│  │Range N  │
                      │                     └────┬────┘  └────┬────┘  └────┬────┘
                      │                          │            │            │
                      └──────────────────────────┴────────────┴────────────┘
                                                       │
                                                       ▼
                                              ┌───────────────┐
                                              │  Auth Signer  │
                                              └───────┬───────┘
                                                      │
                                                      ▼
                                              ┌───────────────┐
                                              │Circuit Breaker│
                                              └───────┬───────┘
                                                      │
                                                      ▼
                                              ┌───────────────┐
                                              │  HTTP Client  │
                                              └───────┬───────┘
                                                      │
                                                      ▼
                                              ┌───────────────┐
                                              │  Azure Files  │
                                              └───────────────┘
```

### 3.2 Streaming Download Flow

```
┌──────────┐     ┌───────────────┐     ┌───────────────┐
│  Caller  │────▶│StreamingService│───▶│Get File Props │
└──────────┘     └───────────────┘     └───────┬───────┘
                                               │
                                               ▼
                                       ┌───────────────┐
                                       │  File Size    │
                                       └───────┬───────┘
                                               │
                                               ▼
                                       ┌───────────────┐
                                       │ Create Stream │
                                       └───────┬───────┘
                                               │
                       ┌───────────────────────┴───────────────────────┐
                       ▼                       ▼                       ▼
                ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
                │ Range 0-4MB │         │Range 4-8MB  │   ...   │ Final Range │
                └──────┬──────┘         └──────┬──────┘         └──────┬──────┘
                       │                       │                       │
                       ▼                       ▼                       ▼
                ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
                │ Yield Bytes │         │ Yield Bytes │         │ Yield Bytes │
                └─────────────┘         └─────────────┘         └─────────────┘
                       │                       │                       │
                       └───────────────────────┴───────────────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   Caller    │
                                        │  Consumes   │
                                        └─────────────┘
```

### 3.3 Lease-Protected Operation Flow

```
┌──────────┐     ┌───────────────┐
│  Caller  │────▶│  with_lock()  │
└──────────┘     └───────┬───────┘
                         │
                         ▼
                 ┌───────────────┐
                 │ Acquire Lease │
                 └───────┬───────┘
                         │
            ┌────────────┴────────────┐
            ▼                         ▼
     ┌─────────────┐          ┌─────────────┐
     │   Success   │          │   Locked    │
     └──────┬──────┘          └──────┬──────┘
            │                        │
            ▼                        ▼
     ┌─────────────┐          ┌─────────────┐
     │Start Renewal│          │Wait & Retry │
     │   Task      │          └──────┬──────┘
     └──────┬──────┘                 │
            │                        └──────▶ (back to Acquire)
            ▼
     ┌─────────────┐
     │  Execute    │
     │  Operation  │
     └──────┬──────┘
            │
     ┌──────┴──────┐
     ▼             ▼
┌─────────┐  ┌─────────┐
│ Success │  │  Error  │
└────┬────┘  └────┬────┘
     │            │
     └─────┬──────┘
           ▼
    ┌─────────────┐
    │Stop Renewal │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │Release Lease│
    └─────────────┘
```

---

## 4. State Machines

### 4.1 Lease State Machine

```
                    ┌─────────────┐
           ────────▶│  Unlocked   │◀──────────────────────┐
                    └──────┬──────┘                       │
                           │ acquire()                    │
                           ▼                              │
                    ┌─────────────┐                       │
                    │  Acquiring  │                       │
                    └──────┬──────┘                       │
                           │                              │
           ┌───────────────┴───────────────┐              │
           ▼                               ▼              │
    ┌─────────────┐                 ┌─────────────┐       │
    │   Locked    │                 │   Failed    │       │
    │  (Leased)   │                 │  (Retry?)   │       │
    └──────┬──────┘                 └──────┬──────┘       │
           │                               │              │
    ┌──────┴──────────────┐                │              │
    │      │              │                │              │
    ▼      ▼              ▼                │              │
┌──────┐┌──────┐   ┌───────────┐           │              │
│renew ││break │   │  release  │           │              │
└──┬───┘└──┬───┘   └─────┬─────┘           │              │
   │       │             │                 │              │
   │       ▼             │                 │              │
   │ ┌───────────┐       │                 │              │
   │ │ Breaking  │       │                 │              │
   │ └─────┬─────┘       │                 │              │
   │       │             │                 │              │
   └───────┴─────────────┴─────────────────┴──────────────┘
```

### 4.2 Streaming Upload State Machine

```
                    ┌─────────────┐
           ────────▶│    Init     │
                    └──────┬──────┘
                           │ create_file()
                           ▼
                    ┌─────────────┐
                    │File Created │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐◀──────┐
                    │  Uploading  │       │
                    └──────┬──────┘       │
                           │              │
           ┌───────────────┼──────────────┤
           ▼               ▼              │
    ┌─────────────┐ ┌─────────────┐       │
    │ Range Done  │ │ Range Error │       │
    └──────┬──────┘ └──────┬──────┘       │
           │               │              │
           │        ┌──────┴──────┐       │
           │        ▼             ▼       │
           │  ┌──────────┐ ┌──────────┐   │
           │  │  Retry   │ │  Failed  │   │
           │  └────┬─────┘ └──────────┘   │
           │       │                      │
           │       └──────────────────────┘
           │
           ▼
    ┌─────────────┐
    │More Ranges? │
    └──────┬──────┘
           │
    ┌──────┴──────┐
    ▼             ▼
┌───────┐   ┌───────────┐
│  Yes  │──▶│ Uploading │
└───────┘   └───────────┘
    │
    ▼ No
┌─────────────┐
│  Complete   │
└─────────────┘
```

### 4.3 Circuit Breaker State Machine

```
             ┌─────────────┐
    ────────▶│   Closed    │◀─────────────────────┐
             └──────┬──────┘                      │
                    │ failures >= threshold       │
                    ▼                             │
             ┌─────────────┐                      │
             │    Open     │                      │
             └──────┬──────┘                      │
                    │ timeout elapsed             │
                    ▼                             │
             ┌─────────────┐                      │
             │  Half-Open  │                      │
             └──────┬──────┘                      │
                    │                             │
        ┌───────────┴───────────┐                 │
        ▼                       ▼                 │
 ┌─────────────┐         ┌─────────────┐          │
 │  Success    │         │   Failure   │          │
 │  (count++)  │         │             │          │
 └──────┬──────┘         └──────┬──────┘          │
        │                       │                 │
        │ successes >=          ▼                 │
        │ threshold      ┌─────────────┐          │
        │                │    Open     │          │
        │                └─────────────┘          │
        └─────────────────────────────────────────┘
```

---

## 5. Integration Points

### 5.1 Shared Module Integration

```
┌─────────────────────────────────────────────────────────────┐
│                  Azure Files Integration                     │
└─────────────────────────────────────────────────────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   shared/   │ │   shared/   │ │   shared/   │ │   shared/   │
│ credentials │ │ resilience  │ │observability│ │    http     │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │               │
       ▼               ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│AzureCredProv│ │   Retry     │ │  Tracing    │ │ HttpClient  │
│ SharedKey   │ │CircuitBreak │ │  Metrics    │ │  Timeouts   │
│    SAS      │ │             │ │             │ │             │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

### 5.2 Observability Integration

```
┌─────────────────────────────────────────────────────────────┐
│                   Azure Files Operation                      │
└──────────────────────────┬──────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │   Tracing   │ │   Metrics   │ │   Logging   │
    │    Span     │ │  Emission   │ │   Output    │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │azure_files. │ │ops_total    │ │ Structured  │
    │  read/write │ │latency_secs │ │   JSON      │
    │  lease      │ │bytes_total  │ │   Logs      │
    └─────────────┘ └─────────────┘ └─────────────┘
```

---

## 6. Concurrency Model

### 6.1 Task Structure

```
┌─────────────────────────────────────────────────────────────┐
│                     Tokio Runtime                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            User Operations (Concurrent)              │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │   │
│  │  │ read()  │ │ write() │ │ list()  │ │ lease() │    │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           Background Tasks (Per-Lease)               │   │
│  │  ┌─────────────────┐  ┌─────────────────┐           │   │
│  │  │ Lease Renewal 1 │  │ Lease Renewal 2 │  ...      │   │
│  │  └─────────────────┘  └─────────────────┘           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Shared State (Thread-Safe)              │   │
│  │  ┌───────────────┐  ┌───────────────┐               │   │
│  │  │Arc<Breaker>   │  │Arc<Transport> │               │   │
│  │  └───────────────┘  └───────────────┘               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. Error Handling Strategy

```
┌─────────────────────────────────────────────────────────────┐
│                    HTTP Response                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Status Code + Headers + Body                          │  │
│  └────────────────────────┬──────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Error Mapping                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Parse x-ms-error-code header + response body          │  │
│  └────────────────────────┬──────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Retry Decision                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ is_retryable() + retry_after() + attempt count        │  │
│  └────────────────────────┬──────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
                ┌───────────┴───────────┐
                ▼                       ▼
         ┌─────────────┐         ┌─────────────┐
         │   Retry     │         │  Propagate  │
         │  (backoff)  │         │  to Caller  │
         └─────────────┘         └─────────────┘
```

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2025-12-13 | SPARC Generator | Initial Architecture phase |

---

**Next Phase:** Refinement - Detailed Rust/TypeScript interface specifications, request/response types, and integration patterns.
