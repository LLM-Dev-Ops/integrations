# SPARC Phase 3: Architecture - Milvus Integration

## 1. System Context (C4 Level 1)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              External Systems                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │  Embedding   │    │   Reranker   │    │  LLM Service │                  │
│  │   Service    │    │   Service    │    │              │                  │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                  │
│         │                   │                   │                           │
│         └───────────────────┼───────────────────┘                           │
│                             │                                               │
│                             ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     LLM DevOps Platform                               │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    RAG Orchestrator                             │  │  │
│  │  └────────────────────────────┬───────────────────────────────────┘  │  │
│  │                               │                                      │  │
│  │  ┌────────────────────────────▼───────────────────────────────────┐  │  │
│  │  │               Milvus Integration Adapter                        │  │  │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌──────────┐  │  │  │
│  │  │  │ Vector  │ │ Search  │ │  Batch  │ │Partition│ │Simulation│  │  │  │
│  │  │  │   Ops   │ │ Engine  │ │ Manager │ │ Router  │ │  Layer   │  │  │  │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └──────────┘  │  │  │
│  │  └────────────────────────────┬───────────────────────────────────┘  │  │
│  │                               │                                      │  │
│  │  ┌────────────────────────────▼───────────────────────────────────┐  │  │
│  │  │              Shared Platform Services                           │  │  │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────────┐   │  │  │
│  │  │  │  Auth   │ │ Logging │ │ Metrics │ │   Vector Memory     │   │  │  │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────────────────┘   │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                  │                                          │
│                                  ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     Milvus Deployment                                 │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │   Self-Hosted Cluster    │        Zilliz Cloud (Managed)       │  │  │
│  │  │  ┌───────┐ ┌───────┐    │    ┌─────────────────────────────┐  │  │  │
│  │  │  │ Proxy │ │ Proxy │    │    │  Serverless / Dedicated     │  │  │  │
│  │  │  └───┬───┘ └───┬───┘    │    │         Endpoint            │  │  │  │
│  │  │      │         │        │    └─────────────────────────────┘  │  │  │
│  │  │  ┌───▼─────────▼───┐    │                                      │  │  │
│  │  │  │   Query Nodes   │    │                                      │  │  │
│  │  │  │   Data Nodes    │    │                                      │  │  │
│  │  │  │   Index Nodes   │    │                                      │  │  │
│  │  │  └─────────────────┘    │                                      │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Container Diagram (C4 Level 2)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Milvus Integration Adapter                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Client Manager                               │   │
│  │  • Client lifecycle management                                       │   │
│  │  • Configuration validation                                          │   │
│  │  • Connection pool orchestration                                     │   │
│  │  • Auto-load coordination                                            │   │
│  └─────────────────────────────┬───────────────────────────────────────┘   │
│                                │                                            │
│         ┌──────────────────────┼──────────────────────┐                    │
│         │                      │                      │                    │
│         ▼                      ▼                      ▼                    │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐              │
│  │   Vector    │       │   Search    │       │ Collection  │              │
│  │  Operations │       │   Engine    │       │  Manager    │              │
│  │             │       │             │       │             │              │
│  │ • Insert    │       │ • Search    │       │ • Load      │              │
│  │ • Upsert    │       │ • Query     │       │ • Release   │              │
│  │ • Delete    │       │ • Hybrid    │       │ • Describe  │              │
│  │ • Get       │       │ • Rerank    │       │ • Stats     │              │
│  └──────┬──────┘       └──────┬──────┘       └──────┬──────┘              │
│         │                      │                      │                    │
│         └──────────────────────┼──────────────────────┘                    │
│                                │                                            │
│  ┌─────────────────────────────▼───────────────────────────────────────┐   │
│  │                       Partition Router                               │   │
│  │  • Partition resolution         • Multi-tenant isolation            │   │
│  │  • Load state awareness         • Routing rules                     │   │
│  └─────────────────────────────┬───────────────────────────────────────┘   │
│                                │                                            │
│  ┌─────────────────────────────▼───────────────────────────────────────┐   │
│  │                      Consistency Manager                             │   │
│  │  • Guarantee timestamp          • Session tracking                   │   │
│  │  • Bounded staleness            • Strong sync                        │   │
│  └─────────────────────────────┬───────────────────────────────────────┘   │
│                                │                                            │
│  ┌─────────────────────────────▼───────────────────────────────────────┐   │
│  │                        gRPC Transport                                │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │   │
│  │  │  Connection   │  │     Auth      │  │    Retry      │            │   │
│  │  │     Pool      │  │  Interceptor  │  │   Handler     │            │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘            │   │
│  └─────────────────────────────┬───────────────────────────────────────┘   │
│                                │                                            │
│  ┌─────────────────────────────┼───────────────────────────────────────┐   │
│  │                      Cross-Cutting Concerns                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │   │
│  │  │Simulation│  │Collection│  │ Metrics  │  │  Error   │             │   │
│  │  │  Layer   │  │  Cache   │  │Collector │  │ Handler  │             │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Component Diagram (C4 Level 3)

### 3.1 Vector Operations Component

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Vector Operations Component                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐      ┌─────────────────────┐                      │
│  │  VectorOperations   │      │   EntityValidator   │                      │
│  │      (trait)        │─────▶│                     │                      │
│  │                     │      │ • validate_fields() │                      │
│  │ • insert()          │      │ • validate_dims()   │                      │
│  │ • upsert()          │      │ • validate_types()  │                      │
│  │ • delete()          │      └─────────────────────┘                      │
│  │ • get()             │                                                    │
│  └──────────┬──────────┘                                                    │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────┐      ┌─────────────────────┐                      │
│  │   FieldSerializer   │      │    Chunker          │                      │
│  │                     │      │                     │                      │
│  │ • to_grpc()         │      │ • chunk_entities()  │                      │
│  │ • from_grpc()       │      │ • estimate_size()   │                      │
│  │ • serialize_vector()│      │ • merge_results()   │                      │
│  └─────────────────────┘      └─────────────────────┘                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Search Engine Component

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Search Engine Component                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐      ┌─────────────────────┐                      │
│  │    SearchEngine     │      │  SearchParamBuilder │                      │
│  │      (trait)        │─────▶│                     │                      │
│  │                     │      │ • for_ivf()         │                      │
│  │ • search()          │      │ • for_hnsw()        │                      │
│  │ • query()           │      │ • for_diskann()     │                      │
│  │ • hybrid_search()   │      │ • for_autoindex()   │                      │
│  │ • range_search()    │      └─────────────────────┘                      │
│  └──────────┬──────────┘                                                    │
│             │                                                               │
│             ▼                                                               │
│  ┌─────────────────────┐      ┌─────────────────────┐                      │
│  │  ExpressionBuilder  │      │   ResultReranker    │                      │
│  │                     │      │                     │                      │
│  │ • build_filter()    │      │ • rrf_fusion()      │                      │
│  │ • validate_expr()   │      │ • weighted_sum()    │                      │
│  │ • escape_values()   │      │ • max_score()       │                      │
│  └─────────────────────┘      └─────────────────────┘                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Collection Manager Component

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Collection Manager Component                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐      ┌─────────────────────┐                      │
│  │  CollectionManager  │      │   LoadStateMonitor  │                      │
│  │      (trait)        │─────▶│                     │                      │
│  │                     │      │ • check_state()     │                      │
│  │ • list()            │      │ • wait_for_load()   │                      │
│  │ • describe()        │      │ • auto_load()       │                      │
│  │ • load()            │      └─────────────────────┘                      │
│  │ • release()         │                                                    │
│  │ • stats()           │      ┌─────────────────────┐                      │
│  └──────────┬──────────┘      │   PartitionManager  │                      │
│             │                 │                     │                      │
│             └────────────────▶│ • list_partitions() │                      │
│                               │ • load_partition()  │                      │
│                               │ • release_partition()│                     │
│                               └─────────────────────┘                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Data Flow Diagrams

### 4.1 Search Flow

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   RAG    │     │  Search  │     │Consistency│    │   gRPC   │     │  Milvus  │
│Orchestrat│     │  Engine  │     │  Manager  │    │Transport │     │  Proxy   │
└────┬─────┘     └────┬─────┘     └────┬──────┘    └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ search_request │                │                │                │
     │───────────────▶│                │                │                │
     │                │                │                │                │
     │                │ build_params   │                │                │
     │                │ (index-aware)  │                │                │
     │                │────────────────│                │                │
     │                │                │                │                │
     │                │ get_guarantee_ts                │                │
     │                │───────────────▶│                │                │
     │                │                │                │                │
     │                │ timestamp      │                │                │
     │                │◀───────────────│                │                │
     │                │                │                │                │
     │                │                │  grpc::Search  │                │
     │                │                │───────────────▶│                │
     │                │                │                │                │
     │                │                │                │ execute_search │
     │                │                │                │───────────────▶│
     │                │                │                │                │
     │                │                │                │    results     │
     │                │                │                │◀───────────────│
     │                │                │                │                │
     │                │  search_hits   │                │                │
     │                │◀───────────────│                │                │
     │                │                │                │                │
     │ retrieval_results               │                │                │
     │◀───────────────│                │                │                │
     │                │                │                │                │
```

### 4.2 Insert Flow with Auto-Load

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │     │  Vector  │     │Collection│     │   gRPC   │     │  Milvus  │
│   App    │     │   Ops    │     │ Manager  │     │Transport │     │  Proxy   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ insert_request │                │                │                │
     │───────────────▶│                │                │                │
     │                │                │                │                │
     │                │ check_load_state               │                │
     │                │───────────────▶│                │                │
     │                │                │                │                │
     │                │                │ GetLoadState   │                │
     │                │                │───────────────▶│                │
     │                │                │                │                │
     │                │                │  NotLoaded     │                │
     │                │                │◀───────────────│                │
     │                │                │                │                │
     │                │ auto_load      │                │                │
     │                │───────────────▶│                │                │
     │                │                │                │                │
     │                │                │ LoadCollection │                │
     │                │                │───────────────▶│                │
     │                │                │                │                │
     │                │                │    success     │                │
     │                │                │◀───────────────│                │
     │                │                │                │                │
     │                │ loaded         │                │                │
     │                │◀───────────────│                │                │
     │                │                │                │                │
     │                │                │  grpc::Insert  │                │
     │                │                │───────────────▶│                │
     │                │                │                │                │
     │                │                │                │    insert      │
     │                │                │                │───────────────▶│
     │                │                │                │                │
     │                │                │                │     ids        │
     │                │                │                │◀───────────────│
     │                │                │                │                │
     │ insert_response│                │                │                │
     │◀───────────────│                │                │                │
     │                │                │                │                │
```

### 4.3 Hybrid Search Flow

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │     │  Search  │     │ Result   │     │  Milvus  │
│   App    │     │  Engine  │     │ Reranker │     │  Proxy   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ hybrid_search  │                │                │
     │ (2 queries)    │                │                │
     │───────────────▶│                │                │
     │                │                │                │
     │                │ search_1 (dense)               │
     │                │───────────────────────────────▶│
     │                │                │                │
     │                │ search_2 (sparse)              │
     │                │───────────────────────────────▶│
     │                │                │                │
     │                │               results_1        │
     │                │◀───────────────────────────────│
     │                │                │                │
     │                │               results_2        │
     │                │◀───────────────────────────────│
     │                │                │                │
     │                │ rrf_fusion     │                │
     │                │───────────────▶│                │
     │                │                │                │
     │                │ merged_ranked  │                │
     │                │◀───────────────│                │
     │                │                │                │
     │ final_results  │                │                │
     │◀───────────────│                │                │
     │                │                │                │
```

### 4.4 Consistency Level Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Consistency Level Handling                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐       │
│  │     Strong      │     │     Session     │     │    Bounded      │       │
│  │                 │     │                 │     │                 │       │
│  │  guarantee_ts   │     │  guarantee_ts   │     │  guarantee_ts   │       │
│  │  = MAX_U64      │     │  = last_write   │     │  = now - 5s     │       │
│  │                 │     │                 │     │                 │       │
│  │  ┌───────────┐  │     │  ┌───────────┐  │     │  ┌───────────┐  │       │
│  │  │ Wait for  │  │     │  │ Session   │  │     │  │ Bounded   │  │       │
│  │  │ full sync │  │     │  │ tracking  │  │     │  │ staleness │  │       │
│  │  └───────────┘  │     │  └───────────┘  │     │  └───────────┘  │       │
│  └────────┬────────┘     └────────┬────────┘     └────────┬────────┘       │
│           │                       │                       │                 │
│           └───────────────────────┼───────────────────────┘                 │
│                                   │                                         │
│                                   ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Search/Query Request                          │  │
│  │                   guarantee_timestamp = calculated_ts                 │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────┐                                                       │
│  │   Eventually    │                                                       │
│  │                 │                                                       │
│  │  guarantee_ts   │     No synchronization required                       │
│  │  = 0            │     Fastest performance                               │
│  │                 │                                                       │
│  └─────────────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Connection Pool Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          gRPC Connection Pool                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Configuration                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ max_connections: 10  │ min_connections: 1  │ idle_timeout: 5min     │   │
│  │ max_lifetime: 30min  │ connect_timeout: 10s│ keepalive: 30s         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    gRPC Channel Management                           │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                    Load Balancer                             │    │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                      │    │   │
│  │  │  │ Proxy 1 │  │ Proxy 2 │  │ Proxy 3 │   (Round Robin)      │    │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘                      │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                 Pooled Connections                           │    │   │
│  │  │  ┌───────────────────────────────────────────────────────┐  │    │   │
│  │  │  │  Channel 1  │  Channel 2  │  Channel 3  │  Channel N  │  │    │   │
│  │  │  │  ┌───────┐  │  ┌───────┐  │  ┌───────┐  │  ┌───────┐  │  │    │   │
│  │  │  │  │ Avail │  │  │ InUse │  │  │ Avail │  │  │ InUse │  │  │    │   │
│  │  │  │  └───────┘  │  └───────┘  │  └───────┘  │  └───────┘  │  │    │   │
│  │  │  └───────────────────────────────────────────────────────┘  │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Auth Interceptor Chain                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Request ──▶ [Token/UserPass] ──▶ [Metadata] ──▶ [TLS] ──▶ Channel  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Partition and Collection Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Collection & Partition Model                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Partition Router                              │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                    Routing Strategy                            │  │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │  │   │
│  │  │  │ tenant_id   │  │ time_range  │  │  category   │            │  │   │
│  │  │  │     ↓       │  │      ↓      │  │      ↓      │            │  │   │
│  │  │  │ "acme-corp" │  │ "2024-Q1"   │  │  "products" │            │  │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘            │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Milvus Cluster                               │   │
│  │                                                                      │   │
│  │  Collection: knowledge_base                                          │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                       Partitions                               │  │   │
│  │  │                                                                │  │   │
│  │  │  ┌──────────────────┐  ┌──────────────────┐                   │  │   │
│  │  │  │ _default         │  │ tenant_acme      │                   │  │   │
│  │  │  │  ┌────────────┐  │  │  ┌────────────┐  │                   │  │   │
│  │  │  │  │ 500K vecs  │  │  │  │ 1.2M vecs  │  │                   │  │   │
│  │  │  │  │ HNSW index │  │  │  │ IVF_FLAT   │  │                   │  │   │
│  │  │  │  └────────────┘  │  │  └────────────┘  │                   │  │   │
│  │  │  └──────────────────┘  └──────────────────┘                   │  │   │
│  │  │                                                                │  │   │
│  │  │  ┌──────────────────┐  ┌──────────────────┐                   │  │   │
│  │  │  │ tenant_beta      │  │ archive_2023     │                   │  │   │
│  │  │  │  ┌────────────┐  │  │  ┌────────────┐  │                   │  │   │
│  │  │  │  │ 800K vecs  │  │  │  │ 5M vecs    │  │                   │  │   │
│  │  │  │  │ HNSW index │  │  │  │ DISKANN    │  │                   │  │   │
│  │  │  │  └────────────┘  │  │  └────────────┘  │                   │  │   │
│  │  │  └──────────────────┘  └──────────────────┘                   │  │   │
│  │  │                                                                │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │  Collection: embeddings                                              │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  ┌──────────────────┐  ┌──────────────────┐                   │  │   │
│  │  │  │ images           │  │ documents        │                   │  │   │
│  │  │  └──────────────────┘  └──────────────────┘                   │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Index Type Decision Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Index Type Selection                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Workload Characteristics                          │   │
│  │                                                                      │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │   │
│  │  │   Data Size     │  │  Query Latency  │  │  Memory Budget  │      │   │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘      │   │
│  │           │                    │                    │                │   │
│  │           └────────────────────┼────────────────────┘                │   │
│  │                                ▼                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Index Recommendations                           │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │  Small (<1M) + Low Latency → FLAT or HNSW                     │  │   │
│  │  │  Medium (1-10M) + Balanced → IVF_FLAT or HNSW                 │  │   │
│  │  │  Large (10M+) + Memory Limited → IVF_PQ or DISKANN            │  │   │
│  │  │  Unknown/Variable → AUTOINDEX                                  │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Search Parameter Mapping                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  Index Type    │ Key Param   │ Default │ Range      │ Trade-off     │   │
│  │  ──────────────┼─────────────┼─────────┼────────────┼───────────────│   │
│  │  FLAT          │ -           │ -       │ -          │ Exact search  │   │
│  │  IVF_FLAT      │ nprobe      │ 10      │ 1-nlist    │ Speed/Recall  │   │
│  │  IVF_PQ        │ nprobe      │ 10      │ 1-nlist    │ Speed/Recall  │   │
│  │  HNSW          │ ef          │ 64      │ top_k-32K  │ Speed/Recall  │   │
│  │  DISKANN       │ search_list │ 100     │ 1-65535    │ Speed/Recall  │   │
│  │  AUTOINDEX     │ level       │ 1       │ 1-5        │ Auto-tuned    │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. RAG Pipeline Integration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          RAG Pipeline Integration                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Query Phase                                   │  │
│  │                                                                       │  │
│  │  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐           │  │
│  │  │  User   │───▶│Embedding│───▶│ Milvus  │───▶│ Reranker│           │  │
│  │  │  Query  │    │ Service │    │ Search  │    │(optional)│          │  │
│  │  └─────────┘    └─────────┘    └─────────┘    └────┬────┘           │  │
│  │                                                     │                │  │
│  └─────────────────────────────────────────────────────┼────────────────┘  │
│                                                        │                    │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    Multi-Collection Search                            │  │
│  │                                                                       │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │  │
│  │  │ knowledge_base│  │   documents   │  │    faqs       │            │  │
│  │  │   (HNSW)      │  │   (IVF_FLAT)  │  │   (FLAT)      │            │  │
│  │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘            │  │
│  │          │                  │                  │                     │  │
│  │          └──────────────────┼──────────────────┘                     │  │
│  │                             │                                        │  │
│  │                             ▼                                        │  │
│  │                   ┌──────────────────┐                              │  │
│  │                   │   RRF Fusion     │                              │  │
│  │                   │   (k=60)         │                              │  │
│  │                   └────────┬─────────┘                              │  │
│  │                            │                                        │  │
│  └────────────────────────────┼────────────────────────────────────────┘  │
│                               │                                            │
│                               ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      Context Assembly                                 │  │
│  │                                                                       │  │
│  │  Retrieved: [doc1: 0.92, doc2: 0.88, doc3: 0.85, ...]               │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────┐    │  │
│  │  │              Context Window Optimizer                        │    │  │
│  │  │  • Token counting    • Relevance cutoff   • Deduplication   │    │  │
│  │  └─────────────────────────────────────────────────────────────┘    │  │
│  │                                                                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Metrics and Observability

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Observability Architecture                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Metrics Collector                               │   │
│  │                                                                      │   │
│  │  Counters                         Histograms                         │   │
│  │  ┌────────────────────────────┐  ┌────────────────────────────┐     │   │
│  │  │ milvus_inserts_total       │  │ milvus_search_latency      │     │   │
│  │  │ milvus_searches_total      │  │   labels: index_type       │     │   │
│  │  │ milvus_queries_total       │  │ milvus_insert_latency      │     │   │
│  │  │ milvus_errors_total        │  │ milvus_batch_size          │     │   │
│  │  │   labels: error_type       │  │ milvus_result_count        │     │   │
│  │  └────────────────────────────┘  └────────────────────────────┘     │   │
│  │                                                                      │   │
│  │  Gauges                                                              │   │
│  │  ┌────────────────────────────┐  ┌────────────────────────────┐     │   │
│  │  │ milvus_pool_connections    │  │ milvus_collections_loaded  │     │   │
│  │  │ milvus_pool_available      │  │ milvus_partitions_loaded   │     │   │
│  │  └────────────────────────────┘  └────────────────────────────┘     │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Structured Logging                              │   │
│  │                                                                      │   │
│  │  {                                                                   │   │
│  │    "timestamp": "2024-01-15T10:30:00Z",                             │   │
│  │    "level": "info",                                                  │   │
│  │    "operation": "search",                                            │   │
│  │    "collection": "knowledge_base",                                   │   │
│  │    "partition": "tenant_acme",                                       │   │
│  │    "index_type": "HNSW",                                            │   │
│  │    "nq": 1,                                                          │   │
│  │    "top_k": 10,                                                      │   │
│  │    "ef": 64,                                                         │   │
│  │    "consistency": "Session",                                         │   │
│  │    "duration_ms": 12,                                                │   │
│  │    "result_count": 10,                                               │   │
│  │    "correlation_id": "abc-123-xyz"                                   │   │
│  │  }                                                                   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes Deployment                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          Namespace: llm-devops                       │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                    Deployment: milvus-adapter                  │  │   │
│  │  │                                                                │  │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐                     │  │   │
│  │  │  │     Pod 1       │  │     Pod 2       │   (HPA: 2-10)       │  │   │
│  │  │  │  ┌───────────┐  │  │  ┌───────────┐  │                     │  │   │
│  │  │  │  │  Adapter  │  │  │  │  Adapter  │  │                     │  │   │
│  │  │  │  │ Container │  │  │  │ Container │  │                     │  │   │
│  │  │  │  └───────────┘  │  │  └───────────┘  │                     │  │   │
│  │  │  └─────────────────┘  └─────────────────┘                     │  │   │
│  │  │                                                                │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────┐  ┌─────────────────────────┐           │   │
│  │  │   Secret: milvus-       │  │  ConfigMap: milvus-     │           │   │
│  │  │       credentials       │  │         config          │           │   │
│  │  │  ┌───────────────────┐  │  │  ┌───────────────────┐  │           │   │
│  │  │  │ token: ***        │  │  │  │ host: milvus.svc  │  │           │   │
│  │  │  │ username: ***     │  │  │  │ port: 19530       │  │           │   │
│  │  │  │ password: ***     │  │  │  │ pool_size: 10     │  │           │   │
│  │  │  └───────────────────┘  │  │  │ consistency: Sess │  │           │   │
│  │  └─────────────────────────┘  │  └───────────────────┘  │           │   │
│  │                               └─────────────────────────┘           │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                  Service: milvus-adapter                       │  │   │
│  │  │              ClusterIP | Port 8080 | gRPC 9090                │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Target: Milvus                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Self-Hosted: milvus.database.svc:19530                             │   │
│  │  Zilliz Cloud: https://xxx.api.zillizcloud.com:443                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. Error Handling Strategy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Error Handling Flow                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     gRPC Error Classification                        │   │
│  │                                                                      │   │
│  │  ┌──────────────────┐     ┌──────────────────┐                      │   │
│  │  │   Retryable      │     │   Non-Retryable  │                      │   │
│  │  │  ┌────────────┐  │     │  ┌────────────┐  │                      │   │
│  │  │  │ Unavailable│  │     │  │Unauthenticd│  │                      │   │
│  │  │  │ Resource   │  │     │  │ Permission │  │                      │   │
│  │  │  │ Exhausted  │  │     │  │ NotFound   │  │                      │   │
│  │  │  │ Internal   │  │     │  │ InvalidArg │  │                      │   │
│  │  │  │ Deadline   │  │     │  │ AlreadyEx  │  │                      │   │
│  │  │  │ Aborted    │  │     │  └────────────┘  │                      │   │
│  │  │  └────────────┘  │     └────────┬─────────┘                      │   │
│  │  └────────┬─────────┘              │                                 │   │
│  │           │                        │                                 │   │
│  │           ▼                        ▼                                 │   │
│  │  ┌──────────────────┐     ┌──────────────────┐                      │   │
│  │  │ Retry with       │     │ Return Error     │                      │   │
│  │  │ Exp. Backoff     │     │ Immediately      │                      │   │
│  │  └──────────────────┘     └──────────────────┘                      │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Special Handling                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  CollectionNotLoaded → Auto-load if config.auto_load = true         │   │
│  │  PartitionNotLoaded → Auto-load partition if auto_load = true       │   │
│  │  Timeout → Retry with extended timeout                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. Security Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Security Architecture                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Authentication Flow                              │   │
│  │                                                                      │   │
│  │  ┌───────────────────┐    ┌───────────────────┐                     │   │
│  │  │  Kubernetes       │───▶│  Credential       │                     │   │
│  │  │  Secret           │    │  Provider         │                     │   │
│  │  └───────────────────┘    └─────────┬─────────┘                     │   │
│  │                                     │                                │   │
│  │                    ┌────────────────┼────────────────┐              │   │
│  │                    ▼                ▼                ▼              │   │
│  │          ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │          │   Token     │  │  UserPass   │  │   mTLS      │         │   │
│  │          │   Auth      │  │    Auth     │  │  (self-host)│         │   │
│  │          └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │   │
│  │                 │                │                │                 │   │
│  │                 └────────────────┼────────────────┘                 │   │
│  │                                  ▼                                  │   │
│  │                       ┌───────────────────┐                        │   │
│  │                       │  Auth Interceptor │                        │   │
│  │                       └───────────────────┘                        │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Transport Security                               │   │
│  │                                                                      │   │
│  │  • TLS 1.2+ enforced for all gRPC connections                       │   │
│  │  • Certificate validation for Zilliz Cloud                          │   │
│  │  • mTLS optional for self-hosted clusters                           │   │
│  │  • No credentials in logs or error messages                         │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 13. Technology Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| Language | Rust | Core implementation |
| Async Runtime | Tokio | Async I/O |
| gRPC Client | tonic | gRPC communication |
| Protobuf | prost | Proto serialization |
| Connection Pool | Custom (tokio-based) | Channel management |
| TLS | rustls | Transport security |
| Metrics | prometheus | Observability |
| Logging | tracing | Structured logging |
| Testing | tokio-test, mockall | Unit/integration tests |

---

## 14. File Structure

```
src/integrations/milvus/
├── mod.rs                          # Module exports
├── client.rs                       # MilvusClient implementation
├── config.rs                       # Configuration types
├── error.rs                        # Error types
│
├── types/
│   ├── mod.rs                      # Type module exports
│   ├── entity.rs                   # Entity, FieldValue types
│   ├── search.rs                   # SearchRequest, SearchResult
│   ├── query.rs                    # QueryRequest, QueryResult
│   ├── collection.rs               # CollectionInfo, Schema
│   ├── partition.rs                # PartitionInfo
│   └── consistency.rs              # ConsistencyLevel
│
├── operations/
│   ├── mod.rs                      # Operations module exports
│   ├── insert.rs                   # Insert/Upsert operations
│   ├── search.rs                   # Search operations
│   ├── query.rs                    # Query operations
│   ├── delete.rs                   # Delete operations
│   └── hybrid.rs                   # Hybrid search
│
├── collection/
│   ├── mod.rs                      # Collection module exports
│   ├── manager.rs                  # CollectionManager
│   ├── loader.rs                   # Load/release logic
│   └── cache.rs                    # Collection info cache
│
├── partition/
│   ├── mod.rs                      # Partition module exports
│   ├── router.rs                   # Partition routing
│   └── manager.rs                  # Partition operations
│
├── transport/
│   ├── mod.rs                      # Transport module exports
│   ├── grpc.rs                     # gRPC client wrapper
│   ├── pool.rs                     # Connection pool
│   ├── interceptor.rs              # Auth interceptor
│   └── retry.rs                    # Retry logic
│
├── search/
│   ├── mod.rs                      # Search module exports
│   ├── params.rs                   # Index-specific params
│   ├── expression.rs               # Filter expression builder
│   └── reranker.rs                 # Result reranking
│
├── consistency/
│   ├── mod.rs                      # Consistency module exports
│   └── manager.rs                  # Consistency management
│
├── rag/
│   ├── mod.rs                      # RAG module exports
│   └── retriever.rs                # RAGRetriever
│
├── simulation/
│   ├── mod.rs                      # Simulation module exports
│   ├── layer.rs                    # SimulationLayer
│   └── storage.rs                  # Recording storage
│
├── metrics/
│   ├── mod.rs                      # Metrics module exports
│   └── collector.rs                # MetricsCollector
│
├── proto/
│   ├── milvus.proto                # Milvus proto definitions
│   └── generated/                  # Generated Rust code
│
└── tests/
    ├── unit/
    ├── integration/
    └── fixtures/
```
