# Google Cloud Logging Integration Module - Architecture

**SPARC Phase 3: Architecture**
**Version:** 1.0.0
**Date:** 2025-12-13
**Module:** `integrations/gcl`

---

## 1. Module Structure

### 1.1 Directory Layout

```
integrations/gcl/
├── Cargo.toml
├── src/
│   ├── lib.rs                 # Public API exports
│   ├── client.rs              # GclClient, GclClientBuilder
│   ├── config.rs              # GclConfig, BufferConfig
│   ├── services/
│   │   ├── mod.rs
│   │   ├── writer.rs          # LogWriter service
│   │   ├── querier.rs         # LogQuerier service
│   │   └── tailer.rs          # LogTailer service
│   ├── buffer/
│   │   ├── mod.rs
│   │   └── log_buffer.rs      # Buffered write queue
│   ├── auth/
│   │   ├── mod.rs
│   │   ├── provider.rs        # GcpAuthProvider trait
│   │   └── token_cache.rs     # Token caching
│   ├── transport/
│   │   ├── mod.rs
│   │   ├── grpc.rs            # gRPC transport
│   │   └── http.rs            # HTTP fallback
│   ├── types/
│   │   ├── mod.rs
│   │   ├── entries.rs         # LogEntry, Severity
│   │   ├── requests.rs        # Request types
│   │   ├── responses.rs       # Response types
│   │   └── resources.rs       # MonitoredResource
│   ├── filter/
│   │   ├── mod.rs
│   │   ├── parser.rs          # Filter expression parser
│   │   └── builder.rs         # Filter builder
│   ├── correlation/
│   │   ├── mod.rs
│   │   └── trace.rs           # Trace context handling
│   ├── simulation/
│   │   ├── mod.rs
│   │   ├── mock.rs            # Mock client
│   │   ├── recorder.rs        # Recording client
│   │   └── replayer.rs        # Replay client
│   └── errors.rs              # Error types
└── tests/
    ├── unit/
    ├── integration/
    └── simulation/
```

### 1.2 Module Dependencies

```
┌─────────────────────────────────────────────────────────────┐
│                        lib.rs                                │
│                    (Public Exports)                          │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
    ┌──────────┐       ┌──────────┐        ┌──────────┐
    │  client  │       │ services │        │  types   │
    └──────────┘       └──────────┘        └──────────┘
          │                   │                   │
          │            ┌──────┴──────┐            │
          │            ▼      ▼      ▼            │
          │      ┌────────┐┌────────┐┌────────┐   │
          │      │ writer ││querier ││ tailer │   │
          │      └────────┘└────────┘└────────┘   │
          │            │      │      │            │
          ▼            ▼      ▼      ▼            ▼
    ┌──────────────────────────────────────────────────┐
    │                    buffer                         │
    └──────────────────────────────────────────────────┘
          │                   │                   │
          ▼                   ▼                   ▼
    ┌──────────┐       ┌──────────┐        ┌──────────┐
    │   auth   │       │transport │        │  filter  │
    └──────────┘       └──────────┘        └──────────┘
          │                   │                   │
          └───────────────────┴───────────────────┘
                              │
                              ▼
                       ┌──────────┐
                       │  errors  │
                       └──────────┘
```

---

## 2. Component Architecture

### 2.1 Client Layer

```
┌─────────────────────────────────────────────────────────────┐
│                        GclClient                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  LogWriter  │  │ LogQuerier  │  │  LogTailer  │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│  ┌──────┴────────────────┴────────────────┴──────┐         │
│  │                  LogBuffer                     │         │
│  └────────────────────────────────────────────────┘         │
│         │                │                │                 │
│  ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐         │
│  │    Auth     │  │  Transport  │  │CircuitBreaker│        │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   Google Cloud Logging API    │
              │     (gRPC / REST)             │
              └───────────────────────────────┘
```

### 2.2 Service Interfaces

```
┌─────────────────────────────────────────────────────────────┐
│                    «trait» LogWriterTrait                    │
├─────────────────────────────────────────────────────────────┤
│ + write(entry: LogEntry) -> Result<()>                      │
│ + write_batch(entries: Vec<LogEntry>) -> Result<BatchResult>│
│ + flush() -> Result<()>                                     │
└─────────────────────────────────────────────────────────────┘
                              △
              ┌───────────────┴───────────────┐
              │                               │
    ┌─────────┴─────────┐          ┌─────────┴─────────┐
    │    LogWriter      │          │  MockLogWriter    │
    │  (Production)     │          │   (Testing)       │
    └───────────────────┘          └───────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   «trait» LogQuerierTrait                    │
├─────────────────────────────────────────────────────────────┤
│ + query(req: QueryRequest) -> Result<QueryResponse>         │
│ + query_all(req: QueryRequest) -> Stream<Result<LogEntry>>  │
│ + query_by_trace(trace_id: String) -> Result<CorrelatedLogs>│
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    «trait» LogTailerTrait                    │
├─────────────────────────────────────────────────────────────┤
│ + tail(req: TailRequest) -> Result<TailStream>              │
│ + tail_with_callback(req, callback) -> Result<TailHandle>   │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Data Flow Diagrams

### 3.1 Write Flow

```
┌──────────┐     ┌───────────┐     ┌───────────┐     ┌─────────┐
│  Caller  │────▶│ LogWriter │────▶│ Enrichment│────▶│ Buffer  │
└──────────┘     └───────────┘     └───────────┘     └────┬────┘
                                                          │
                      ┌───────────────────────────────────┘
                      │
                      ▼ (flush trigger)
              ┌───────────────┐
              │ Batch Builder │
              └───────┬───────┘
                      │
         ┌────────────┼────────────┐
         ▼            ▼            ▼
    ┌─────────┐  ┌─────────┐  ┌─────────┐
    │ Batch 1 │  │ Batch 2 │  │ Batch N │
    └────┬────┘  └────┬────┘  └────┬────┘
         │            │            │
         └────────────┼────────────┘
                      ▼
              ┌───────────────┐     ┌─────────────────┐
              │Circuit Breaker│────▶│  Retry Logic    │
              └───────────────┘     └────────┬────────┘
                                             │
                                             ▼
                                    ┌────────────────┐
                                    │  gRPC Client   │
                                    └────────┬───────┘
                                             │
                                             ▼
                                    ┌────────────────┐
                                    │ Cloud Logging  │
                                    │     API        │
                                    └────────────────┘
```

### 3.2 Query Flow

```
┌──────────┐     ┌────────────┐     ┌──────────────┐
│  Caller  │────▶│ LogQuerier │────▶│ Filter Parser│
└──────────┘     └─────┬──────┘     └──────────────┘
                       │
                       ▼
              ┌────────────────┐
              │ Request Builder│
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │   Auth Token   │
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │  gRPC Client   │◀─────┐
              └────────┬───────┘      │
                       │              │ (retry)
                       ▼              │
              ┌────────────────┐      │
              │ Cloud Logging  │──────┘
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │Response Parser │
              └────────┬───────┘
                       │
          ┌────────────┴────────────┐
          ▼                         ▼
   ┌─────────────┐          ┌─────────────┐
   │ Single Page │          │ Auto-Paging │
   │  Response   │          │   Stream    │
   └─────────────┘          └─────────────┘
```

### 3.3 Tail Streaming Flow

```
┌──────────┐     ┌───────────┐     ┌────────────────┐
│  Caller  │────▶│ LogTailer │────▶│ Stream Manager │
└──────────┘     └───────────┘     └───────┬────────┘
                                           │
                                           ▼
                                   ┌───────────────┐
                                   │ gRPC Bidi     │
                                   │   Stream      │
                                   └───────┬───────┘
                                           │
                      ┌────────────────────┼────────────────────┐
                      │                    │                    │
                      ▼                    ▼                    ▼
               ┌───────────┐        ┌───────────┐        ┌───────────┐
               │  Entry    │        │Suppression│        │  Error/   │
               │ Received  │        │   Info    │        │Disconnect │
               └─────┬─────┘        └─────┬─────┘        └─────┬─────┘
                     │                    │                    │
                     ▼                    ▼                    ▼
               ┌───────────┐        ┌───────────┐        ┌───────────┐
               │  Parse &  │        │   Log     │        │ Reconnect │
               │   Yield   │        │  Warning  │        │   Logic   │
               └───────────┘        └───────────┘        └───────────┘
```

---

## 4. State Machines

### 4.1 Buffer State Machine

```
                    ┌─────────────────┐
                    │                 │
                    ▼                 │
             ┌─────────────┐          │
    ────────▶│    Empty    │          │
             └──────┬──────┘          │
                    │ add(entry)      │
                    ▼                 │
             ┌─────────────┐          │
             │  Buffering  │◀─────────┤
             └──────┬──────┘          │
                    │                 │
        ┌───────────┼───────────┐     │
        │           │           │     │
        ▼           ▼           ▼     │
   threshold    interval    explicit  │
    reached     elapsed      flush    │
        │           │           │     │
        └───────────┼───────────┘     │
                    ▼                 │
             ┌─────────────┐          │
             │  Flushing   │          │
             └──────┬──────┘          │
                    │                 │
        ┌───────────┴───────────┐     │
        ▼                       ▼     │
   ┌─────────┐            ┌─────────┐ │
   │ Success │            │ Failure │ │
   └────┬────┘            └────┬────┘ │
        │                      │      │
        │                      ▼      │
        │               ┌───────────┐ │
        │               │ Re-queue  │ │
        │               │  Entries  │ │
        │               └─────┬─────┘ │
        │                     │       │
        └─────────────────────┴───────┘
```

### 4.2 Tail Stream State Machine

```
             ┌─────────────┐
    ────────▶│Disconnected │
             └──────┬──────┘
                    │ connect()
                    ▼
             ┌─────────────┐
             │ Connecting  │
             └──────┬──────┘
                    │
        ┌───────────┴───────────┐
        ▼                       ▼
   ┌─────────┐            ┌─────────┐
   │Connected│            │  Error  │
   └────┬────┘            └────┬────┘
        │                      │
        ▼                      │ retry < max
   ┌─────────┐                 │
   │Streaming│◀────────────────┘
   └────┬────┘
        │
        ├──────────────┐
        ▼              ▼
   ┌─────────┐    ┌─────────┐
   │ Receive │    │  Error  │
   │  Entry  │    │Received │
   └────┬────┘    └────┬────┘
        │              │
        │         ┌────┴────┐
        │         ▼         ▼
        │   ┌─────────┐ ┌───────┐
        │   │Reconnect│ │ Fatal │
        │   └────┬────┘ └───┬───┘
        │        │          │
        └────────┘          ▼
                      ┌───────────┐
                      │Disconnected│
                      │  (final)   │
                      └───────────┘
```

### 4.3 Circuit Breaker State Machine

```
             ┌─────────────┐
    ────────▶│   Closed    │◀─────────────────────┐
             └──────┬──────┘                      │
                    │ failure_count               │
                    │ >= threshold                │
                    ▼                             │
             ┌─────────────┐                      │
             │    Open     │                      │
             └──────┬──────┘                      │
                    │ reset_timeout               │
                    │ elapsed                     │
                    ▼                             │
             ┌─────────────┐                      │
             │  Half-Open  │                      │
             └──────┬──────┘                      │
                    │                             │
        ┌───────────┴───────────┐                 │
        ▼                       ▼                 │
   ┌─────────┐            ┌─────────┐             │
   │ Success │            │ Failure │             │
   │ Count++ │            │         │             │
   └────┬────┘            └────┬────┘             │
        │                      │                  │
        │ success >=           │                  │
        │ threshold            ▼                  │
        │               ┌─────────────┐           │
        └───────────────│    Open     │           │
                        └─────────────┘           │
```

---

## 5. Integration Points

### 5.1 Shared Module Integration

```
┌─────────────────────────────────────────────────────────────┐
│                     GCL Integration                          │
└─────────────────────────────────────────────────────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   shared/   │ │   shared/   │ │   shared/   │ │   shared/   │
│ credentials │ │ resilience  │ │observability│ │    http     │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │               │
       ▼               ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│GcpCredential│ │   Retry     │ │  Tracing    │ │ HttpClient  │
│  Provider   │ │CircuitBreak │ │  Metrics    │ │ GrpcClient  │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

### 5.2 Observability Integration

```
┌─────────────────────────────────────────────────────────────┐
│                    GCL Operation                             │
└──────────────────────────┬──────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │   Tracing   │ │   Metrics   │ │   Logging   │
    │    Span     │ │  Emission   │ │   Output    │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ gcl.write   │ │entries_total│ │ Structured  │
    │ gcl.query   │ │latency_secs │ │   JSON      │
    │ gcl.tail    │ │buffer_size  │ │   Logs      │
    └─────────────┘ └─────────────┘ └─────────────┘
```

---

## 6. Error Handling Strategy

### 6.1 Error Propagation

```
┌─────────────────────────────────────────────────────────────┐
│                    Transport Layer                           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ gRPC Status / HTTP Status                             │  │
│  └────────────────────────┬──────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Error Mapping                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ NetworkError | ServerError | AuthError                │  │
│  └────────────────────────┬──────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Retry Decision                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ is_retryable() -> bool                                │  │
│  │ retry_after() -> Option<Duration>                     │  │
│  └────────────────────────┬──────────────────────────────┘  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
                ┌───────────┴───────────┐
                ▼                       ▼
         ┌─────────────┐         ┌─────────────┐
         │   Retry     │         │  Propagate  │
         │  Operation  │         │   to User   │
         └─────────────┘         └─────────────┘
```

---

## 7. Concurrency Model

### 7.1 Task Structure

```
┌─────────────────────────────────────────────────────────────┐
│                     Tokio Runtime                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │ Flush Task      │  │ Token Refresh   │                  │
│  │ (Background)    │  │ (Background)    │                  │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              User Operations (Concurrent)            │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │   │
│  │  │ write() │ │ write() │ │ query() │ │ tail()  │    │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Shared State (Thread-Safe)              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │Arc<Buffer>  │ │Arc<Breaker> │ │Arc<TokenCache│   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2025-12-13 | SPARC Generator | Initial Architecture phase |

---

**Next Phase:** Refinement - Detailed Rust/TypeScript interface specifications, request/response types, and integration patterns.
