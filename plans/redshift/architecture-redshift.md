# Amazon Redshift Integration Module - Architecture

**SPARC Phase 3: Architecture**
**Version:** 1.0.0
**Date:** 2025-12-13
**Module:** `integrations/aws/redshift`

---

## 1. C4 Model Diagrams

### 1.1 Context Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        LLM Dev Ops Platform                              │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │   Analytics  │  │    Feature   │  │   Reporting  │                  │
│  │   Workflows  │  │  Extraction  │  │   Services   │                  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                  │
│         │                 │                 │                           │
│         └─────────────────┼─────────────────┘                           │
│                           ▼                                              │
│              ┌────────────────────────┐                                 │
│              │   Redshift Integration │                                 │
│              │        Module          │                                 │
│              └───────────┬────────────┘                                 │
└──────────────────────────┼──────────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │  Amazon    │  │  Amazon    │  │   AWS      │
    │  Redshift  │  │    S3      │  │   Glue     │
    │  Cluster   │  │  (Data)    │  │ (Catalog)  │
    └────────────┘  └────────────┘  └────────────┘
```

### 1.2 Container Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Redshift Integration Module                         │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Public API Layer                         │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │   │
│  │  │  Query   │ │   Data   │ │ Workload │ │ Spectrum │           │   │
│  │  │ Service  │ │  Load    │ │  Mgmt    │ │ Service  │           │   │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │   │
│  └───────┼────────────┼────────────┼────────────┼──────────────────┘   │
│          │            │            │            │                       │
│  ┌───────┴────────────┴────────────┴────────────┴──────────────────┐   │
│  │                       Core Services Layer                        │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │  Connection  │  │  Transaction │  │   Prepared   │           │   │
│  │  │    Pool      │  │   Manager    │  │  Statements  │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                      Infrastructure Layer                         │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐    │   │
│  │  │    Wire    │ │   Error    │ │   Query    │ │    SQL     │    │   │
│  │  │  Protocol  │ │  Mapper    │ │  Builder   │ │  Parser    │    │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                       Shared Dependencies                         │   │
│  │     aws/auth      shared/resilience      shared/observability    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 Component Diagram

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            Query Service                                    │
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │   Sync      │  │   Async     │  │   Stream    │  │   Explain   │       │
│  │  Executor   │  │  Executor   │  │  Executor   │  │  Analyzer   │       │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
│         │                │                │                │               │
│         └────────────────┴────────────────┴────────────────┘               │
│                                    │                                        │
│                          ┌─────────▼─────────┐                             │
│                          │   Query Router    │                             │
│                          │  (WLM-aware)      │                             │
│                          └─────────┬─────────┘                             │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼────────────────────────────────────────┐
│                           Connection Pool                                   │
│                                    │                                        │
│  ┌────────────┐  ┌────────────────▼───────────────┐  ┌────────────┐       │
│  │  Health    │  │                                 │  │  Session   │       │
│  │  Checker   │──│       Pool Manager              │──│  Manager   │       │
│  └────────────┘  │                                 │  └────────────┘       │
│                  │  ┌─────┐ ┌─────┐ ┌─────┐       │                        │
│                  │  │Conn │ │Conn │ │Conn │ ...   │                        │
│                  │  │  1  │ │  2  │ │  N  │       │                        │
│                  │  └─────┘ └─────┘ └─────┘       │                        │
│                  └─────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Module Structure

```
integrations/aws/redshift/
├── mod.rs                      # Public exports
├── client.rs                   # RedshiftClient implementation
├── config.rs                   # Configuration types
├── error.rs                    # Error types and mapping
│
├── connection/
│   ├── mod.rs                  # Connection module exports
│   ├── pool.rs                 # Connection pool implementation
│   ├── health.rs               # Health checking
│   ├── session.rs              # Session parameter management
│   └── wire.rs                 # PostgreSQL wire protocol
│
├── query/
│   ├── mod.rs                  # Query module exports
│   ├── executor.rs             # Query execution
│   ├── async_executor.rs       # Async query handling
│   ├── stream.rs               # Result streaming
│   ├── prepared.rs             # Prepared statements
│   ├── builder.rs              # Query builder utilities
│   └── explain.rs              # Query plan analysis
│
├── data/
│   ├── mod.rs                  # Data operations exports
│   ├── copy.rs                 # COPY command implementation
│   ├── unload.rs               # UNLOAD command implementation
│   ├── format.rs               # Data format handling
│   └── manifest.rs             # Manifest file handling
│
├── transaction/
│   ├── mod.rs                  # Transaction exports
│   └── manager.rs              # Transaction lifecycle
│
├── workload/
│   ├── mod.rs                  # Workload management exports
│   ├── wlm.rs                  # WLM queue operations
│   ├── monitor.rs              # Query monitoring
│   └── cancel.rs               # Query cancellation
│
├── spectrum/
│   ├── mod.rs                  # Spectrum exports
│   ├── external.rs             # External schema/table operations
│   └── catalog.rs              # Glue catalog integration
│
├── types/
│   ├── mod.rs                  # Type exports
│   ├── value.rs                # Value types
│   ├── column.rs               # Column metadata
│   ├── result.rs               # Result set types
│   └── convert.rs              # Type conversions
│
└── simulation/
    ├── mod.rs                  # Simulation exports
    ├── mock_client.rs          # Mock client implementation
    ├── memory_store.rs         # In-memory table storage
    └── recorder.rs             # Query recording/replay
```

---

## 3. Data Flow Diagrams

### 3.1 Query Execution Flow

```
┌──────────┐     ┌──────────────┐     ┌─────────────┐     ┌──────────┐
│  Caller  │────▶│ QueryService │────▶│   Circuit   │────▶│  Retry   │
└──────────┘     └──────────────┘     │   Breaker   │     │  Policy  │
                                      └─────────────┘     └────┬─────┘
                                                               │
     ┌─────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Connection │────▶│   Session   │────▶│   Query     │
│    Pool     │     │    Setup    │     │  Executor   │
└─────────────┘     │ (query_grp) │     └──────┬──────┘
                    └─────────────┘            │
                                               ▼
                                      ┌─────────────┐
                                      │  Redshift   │
                                      │   Cluster   │
                                      └──────┬──────┘
                                             │
     ┌───────────────────────────────────────┘
     │
     ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Result    │────▶│    Type     │────▶│   Return    │
│   Parser    │     │  Converter  │     │   Result    │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 3.2 COPY Data Loading Flow

```
┌──────────┐     ┌──────────────┐     ┌─────────────┐
│  Caller  │────▶│ DataLoadSvc  │────▶│  Validate   │
└──────────┘     └──────────────┘     │   Command   │
                                      └──────┬──────┘
                                             │
                                             ▼
                                      ┌─────────────┐
                                      │ Build COPY  │
                                      │    SQL      │
                                      └──────┬──────┘
                                             │
                                             ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Acquire    │◀───│  Connection │◀────│  Execute    │
│    Conn     │    │    Pool     │     │   (async)   │
└─────────────┘    └─────────────┘     └──────┬──────┘
                                              │
         ┌────────────────────────────────────┘
         │
         ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Redshift  │────▶│   S3 Data   │────▶│   Table     │
│   Cluster   │     │   Source    │     │   Load      │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
                                      ┌─────────────┐
                                      │ STL_LOAD_   │
                                      │   ERRORS    │
                                      └──────┬──────┘
                                             │
     ┌───────────────────────────────────────┘
     │
     ▼
┌─────────────┐     ┌─────────────┐
│   Check     │────▶│   Return    │
│   Errors    │     │   Result    │
└─────────────┘     └─────────────┘
```

### 3.3 Connection Pool Lifecycle

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Connection Pool                                  │
│                                                                          │
│   INIT                                                                   │
│    │                                                                     │
│    ▼                                                                     │
│  ┌─────────┐    warm_up()     ┌─────────────────────────────────────┐  │
│  │ Create  │─────────────────▶│          Available Queue            │  │
│  │  Pool   │                  │  ┌────┐ ┌────┐ ┌────┐              │  │
│  └─────────┘                  │  │ C1 │ │ C2 │ │... │              │  │
│                               │  └────┘ └────┘ └────┘              │  │
│                               └────────────┬────────────────────────┘  │
│                                            │                            │
│                     acquire()              │              release()     │
│                         │                  │                  │         │
│                         ▼                  ▼                  │         │
│                    ┌─────────────────────────────────────┐    │         │
│                    │           In-Use Set                │◀───┘         │
│                    │  ┌────┐ ┌────┐ ┌────┐              │              │
│                    │  │ Cx │ │ Cy │ │... │              │              │
│                    │  └────┘ └────┘ └────┘              │              │
│                    └─────────────────────────────────────┘              │
│                                                                          │
│   Background:  ┌────────────────────────────────────────────────────┐   │
│                │  Health Checker (periodic)                          │   │
│                │  - Validate idle connections                        │   │
│                │  - Remove stale connections                         │   │
│                │  - Maintain min_connections                         │   │
│                └────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Connection Architecture

### 4.1 Connection Establishment

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Connection Establishment                            │
│                                                                          │
│  ┌──────────────┐                                                       │
│  │  Credential  │                                                       │
│  │   Provider   │                                                       │
│  └──────┬───────┘                                                       │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │  IAM Token   │────▶│    Build     │────▶│     TLS      │            │
│  │  Generation  │     │  Conn String │     │   Handshake  │            │
│  └──────────────┘     └──────────────┘     └──────┬───────┘            │
│                                                    │                     │
│                                                    ▼                     │
│                                            ┌──────────────┐             │
│                                            │  PostgreSQL  │             │
│                                            │    Auth      │             │
│                                            └──────┬───────┘             │
│                                                   │                      │
│         ┌─────────────────────────────────────────┘                     │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │   Session    │────▶│   Register   │────▶│   Return     │            │
│  │    Init      │     │   in Pool    │     │  Connection  │            │
│  └──────────────┘     └──────────────┘     └──────────────┘            │
└─────────────────────────────────────────────────────────────────────────┘

Credential Sources:
┌────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  IAM Role   │  │  Secrets    │  │  Database   │            │
│  │  (GetDB     │  │   Manager   │  │  Username/  │            │
│  │   Token)    │  │             │  │  Password   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### 4.2 Session Management

```
Session Parameters:
┌─────────────────────────────────────────────────────────────┐
│                                                              │
│  ┌────────────────┐  ┌────────────────┐  ┌───────────────┐ │
│  │  query_group   │  │ statement_     │  │  search_path  │ │
│  │  (WLM routing) │  │ timeout        │  │               │ │
│  └────────────────┘  └────────────────┘  └───────────────┘ │
│                                                              │
│  ┌────────────────┐  ┌────────────────┐  ┌───────────────┐ │
│  │  query_label   │  │   datestyle    │  │   timezone    │ │
│  │  (tracing)     │  │                │  │               │ │
│  └────────────────┘  └────────────────┘  └───────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘

Reset on Release:
┌─────────────────────────────────────────────────────────────┐
│  RESET ALL → Clears all session parameters                   │
│  ABORT     → Ensures no open transaction                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. Workload Management Architecture

### 5.1 WLM Queue Routing

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        WLM Queue Architecture                            │
│                                                                          │
│  Incoming Query                                                          │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────┐                                                        │
│  │   Query     │                                                        │
│  │   Group     │                                                        │
│  │   Set?      │                                                        │
│  └──────┬──────┘                                                        │
│         │                                                                │
│    ┌────┴────┐                                                          │
│    │         │                                                          │
│    ▼         ▼                                                          │
│  ┌─────┐  ┌─────────────────────────────────────────────────────────┐  │
│  │ No  │  │                    Queue Matcher                        │  │
│  └──┬──┘  │                                                         │  │
│     │     │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│     │     │  │ High Prio   │  │ Normal      │  │ Batch       │     │  │
│     │     │  │ query_grp:  │  │ query_grp:  │  │ query_grp:  │     │  │
│     │     │  │ 'dashboard' │  │ 'analytics' │  │ 'etl'       │     │  │
│     │     │  │ slots: 5    │  │ slots: 10   │  │ slots: 3    │     │  │
│     │     │  │ mem: 25%    │  │ mem: 50%    │  │ mem: 20%    │     │  │
│     │     │  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│     │     │                                                         │  │
│     │     └─────────────────────────────────────────────────────────┘  │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Default Queue                             │   │
│  │                        slots: 5, mem: 5%                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Query Monitoring

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Query Monitoring Architecture                       │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    System Tables                                 │   │
│  │                                                                  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │   │
│  │  │STV_RECENTS  │  │SVL_QLOG     │  │STL_QUERY    │             │   │
│  │  │(Running)    │  │(History)    │  │(Metrics)    │             │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │   │
│  │         │                │                │                     │   │
│  │         └────────────────┼────────────────┘                     │   │
│  │                          │                                       │   │
│  └──────────────────────────┼───────────────────────────────────────┘   │
│                             │                                            │
│                             ▼                                            │
│                    ┌─────────────────┐                                  │
│                    │  Query Monitor  │                                  │
│                    │     Service     │                                  │
│                    └────────┬────────┘                                  │
│                             │                                            │
│              ┌──────────────┼──────────────┐                            │
│              │              │              │                            │
│              ▼              ▼              ▼                            │
│       ┌───────────┐  ┌───────────┐  ┌───────────┐                      │
│       │  Metrics  │  │   Alerts  │  │  Cancel   │                      │
│       │  Export   │  │ (Timeout) │  │  Trigger  │                      │
│       └───────────┘  └───────────┘  └───────────┘                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Data Loading Architecture

### 6.1 COPY Pipeline

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         COPY Pipeline                                    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                        S3 Sources                               │    │
│  │                                                                 │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │    │
│  │  │  Prefix     │  │  Manifest   │  │  Single     │            │    │
│  │  │  (parallel) │  │  (explicit) │  │  File       │            │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘            │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                               │                                          │
│                               ▼                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Format Parsers                               │    │
│  │                                                                 │    │
│  │  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐           │    │
│  │  │  CSV  │ │ JSON  │ │Parquet│ │  ORC  │ │ Avro  │           │    │
│  │  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘           │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                               │                                          │
│                               ▼                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                   Redshift Loader                               │    │
│  │                                                                 │    │
│  │  ┌─────────────────┐  ┌─────────────────┐                      │    │
│  │  │  Slice-based    │  │   Error         │                      │    │
│  │  │  Parallel Load  │  │   Handling      │                      │    │
│  │  └─────────────────┘  └─────────────────┘                      │    │
│  │                                                                 │    │
│  │  ┌─────────────────────────────────────────────────────────┐  │    │
│  │  │  STL_LOAD_ERRORS   STL_LOAD_COMMITS   STL_LOADERROR_*   │  │    │
│  │  └─────────────────────────────────────────────────────────┘  │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 UNLOAD Pipeline

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        UNLOAD Pipeline                                   │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      Query Execution                            │    │
│  │                                                                 │    │
│  │    SELECT ... FROM ... WHERE ...                                │    │
│  │                                                                 │    │
│  └──────────────────────────────┬─────────────────────────────────┘    │
│                                 │                                        │
│                                 ▼                                        │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Parallel Writers                             │    │
│  │                                                                 │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │    │
│  │  │ Slice 0 │  │ Slice 1 │  │ Slice 2 │  │ Slice N │           │    │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │    │
│  │       │            │            │            │                 │    │
│  └───────┼────────────┼────────────┼────────────┼─────────────────┘    │
│          │            │            │            │                       │
│          ▼            ▼            ▼            ▼                       │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                        S3 Destination                           │    │
│  │                                                                 │    │
│  │  s3://bucket/prefix/                                            │    │
│  │  ├── 0000_part_00                                               │    │
│  │  ├── 0001_part_00                                               │    │
│  │  ├── 0002_part_00                                               │    │
│  │  ├── ...                                                        │    │
│  │  └── manifest (optional)                                        │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Spectrum Architecture

### 7.1 External Table Query Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Spectrum Query Architecture                          │
│                                                                          │
│  ┌────────────────┐                                                     │
│  │  Query with    │                                                     │
│  │  External      │                                                     │
│  │  Schema Ref    │                                                     │
│  └───────┬────────┘                                                     │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────┐     ┌────────────────┐                             │
│  │   Redshift     │────▶│   AWS Glue     │                             │
│  │   Leader Node  │     │   Data Catalog │                             │
│  └───────┬────────┘     └────────────────┘                             │
│          │                      │                                        │
│          │              ┌───────┴───────┐                               │
│          │              │   Table       │                               │
│          │              │   Metadata    │                               │
│          │              └───────────────┘                               │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Spectrum Layer                               │    │
│  │                                                                 │    │
│  │  ┌─────────────────┐  ┌─────────────────┐                      │    │
│  │  │  Predicate      │  │  Projection     │                      │    │
│  │  │  Pushdown       │  │  Pushdown       │                      │    │
│  │  └─────────────────┘  └─────────────────┘                      │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                               │                                          │
│                               ▼                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                          S3 Data                                │    │
│  │                                                                 │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │    │
│  │  │Partition│  │Partition│  │Partition│  │Partition│           │    │
│  │  │   A     │  │   B     │  │   C     │  │  ...    │           │    │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘           │    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Error Handling Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Error Handling Pipeline                             │
│                                                                          │
│  ┌────────────────┐                                                     │
│  │  PostgreSQL    │                                                     │
│  │  Error Response│                                                     │
│  └───────┬────────┘                                                     │
│          │                                                               │
│          ▼                                                               │
│  ┌────────────────┐     ┌────────────────────────────────────────┐     │
│  │  SQL State     │────▶│            Error Mapper                 │     │
│  │  Extraction    │     │                                        │     │
│  └────────────────┘     │  08xxx → ConnectionFailed              │     │
│                         │  28xxx → AuthenticationFailed          │     │
│                         │  40001 → SerializationFailure          │     │
│                         │  42xxx → SQL Errors (Table/Column)     │     │
│                         │  53xxx → Resource Errors               │     │
│                         │  57014 → QueryCancelled                │     │
│                         └───────────────┬────────────────────────┘     │
│                                         │                               │
│                    ┌────────────────────┼────────────────────┐         │
│                    │                    │                    │         │
│                    ▼                    ▼                    ▼         │
│             ┌───────────┐        ┌───────────┐        ┌───────────┐   │
│             │ Retryable │        │   Fatal   │        │   Log &   │   │
│             │  → Retry  │        │  → Raise  │        │   Metric  │   │
│             └───────────┘        └───────────┘        └───────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

Retryable Errors:
┌──────────────────────────────────────────────────────────────┐
│  ConnectionFailed, QueryTimeout, SerializationFailure,       │
│  OutOfMemory, ResourceBusy, SpectrumError                    │
└──────────────────────────────────────────────────────────────┘

Non-Retryable Errors:
┌──────────────────────────────────────────────────────────────┐
│  AuthenticationFailed, InvalidSql, TableNotFound,            │
│  ColumnNotFound, PermissionDenied, QueryCancelled            │
└──────────────────────────────────────────────────────────────┘
```

---

## 9. Observability Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Observability Integration                           │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Metrics                                  │   │
│  │                                                                  │   │
│  │  redshift.query.duration_ms     (histogram)                     │   │
│  │  redshift.query.success         (counter)                       │   │
│  │  redshift.query.error           (counter, by error_type)        │   │
│  │  redshift.connection.pool_size  (gauge)                         │   │
│  │  redshift.connection.in_use     (gauge)                         │   │
│  │  redshift.connection.wait_ms    (histogram)                     │   │
│  │  redshift.copy.rows_loaded      (counter)                       │   │
│  │  redshift.copy.duration_ms      (histogram)                     │   │
│  │  redshift.unload.rows           (counter)                       │   │
│  │  redshift.spectrum.bytes_scanned(counter)                       │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                          Traces                                  │   │
│  │                                                                  │   │
│  │  redshift.execute_query                                         │   │
│  │    ├── acquire_connection                                       │   │
│  │    ├── session_setup                                            │   │
│  │    ├── execute_statement                                        │   │
│  │    ├── parse_results                                            │   │
│  │    └── release_connection                                       │   │
│  │                                                                  │   │
│  │  redshift.copy_from_s3                                          │   │
│  │    ├── validate_command                                         │   │
│  │    ├── build_sql                                                │   │
│  │    ├── execute_copy                                             │   │
│  │    └── check_errors                                             │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                           Logs                                   │   │
│  │                                                                  │   │
│  │  {                                                               │   │
│  │    "level": "info",                                              │   │
│  │    "component": "redshift",                                      │   │
│  │    "operation": "execute_query",                                 │   │
│  │    "query_id": "abc123",                                         │   │
│  │    "duration_ms": 1234,                                          │   │
│  │    "rows_returned": 5000,                                        │   │
│  │    "queue": "analytics"                                          │   │
│  │    // SQL text is REDACTED                                       │   │
│  │  }                                                               │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Simulation Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Simulation Layer                                    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    MockRedshiftClient                            │   │
│  │                                                                  │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │   │
│  │  │  In-Memory    │  │    Query      │  │    Error      │       │   │
│  │  │  Table Store  │  │   Recorder    │  │   Injector    │       │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘       │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Recording/Replay                              │   │
│  │                                                                  │   │
│  │  Record Mode:                                                    │   │
│  │  ┌──────────┐     ┌──────────┐     ┌──────────┐                │   │
│  │  │  Query   │────▶│  Record  │────▶│   Store  │                │   │
│  │  │Execution │     │ Request/ │     │ Sequence │                │   │
│  │  │          │     │ Response │     │          │                │   │
│  │  └──────────┘     └──────────┘     └──────────┘                │   │
│  │                                                                  │   │
│  │  Replay Mode:                                                    │   │
│  │  ┌──────────┐     ┌──────────┐     ┌──────────┐                │   │
│  │  │  Load    │────▶│  Match   │────▶│  Return  │                │   │
│  │  │ Sequence │     │  Query   │     │ Response │                │   │
│  │  └──────────┘     └──────────┘     └──────────┘                │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 11. Integration Dependencies

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      External Dependencies                               │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      Shared Modules                              │   │
│  │                                                                  │   │
│  │  aws/auth                                                        │   │
│  │  ├── get_credentials() → Credentials                            │   │
│  │  ├── assume_role(arn) → Credentials                             │   │
│  │  └── get_db_auth_token(cluster, user) → Token                   │   │
│  │                                                                  │   │
│  │  shared/resilience                                               │   │
│  │  ├── RetryPolicy (configurable)                                 │   │
│  │  ├── CircuitBreaker (per cluster)                               │   │
│  │  └── RateLimiter (query concurrency)                            │   │
│  │                                                                  │   │
│  │  shared/observability                                            │   │
│  │  ├── MetricsClient                                              │   │
│  │  ├── TracingContext                                             │   │
│  │  └── StructuredLogger                                           │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Related AWS Services                           │   │
│  │                                                                  │   │
│  │  aws/s3                                                          │   │
│  │  ├── COPY source paths                                          │   │
│  │  ├── UNLOAD destination paths                                   │   │
│  │  └── Manifest file handling                                     │   │
│  │                                                                  │   │
│  │  aws/glue                                                        │   │
│  │  ├── External schema catalog                                    │   │
│  │  └── Table metadata for Spectrum                                │   │
│  │                                                                  │   │
│  │  aws/secrets_manager                                             │   │
│  │  └── Database credential storage                                │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## SPARC Phase Summary

| Phase | Document | Status |
|-------|----------|--------|
| 1. Specification | specification-redshift.md | Complete |
| 2. Pseudocode | pseudocode-redshift.md | Complete |
| 3. Architecture | architecture-redshift.md | Complete |
| 4. Refinement | refinement-redshift.md | Pending |
| 5. Completion | completion-redshift.md | Pending |

---

*Phase 3: Architecture - Complete*
