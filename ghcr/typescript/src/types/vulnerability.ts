/**
 * Vulnerability types for GitHub Container Registry.
 * @module types/vulnerability
 */

/**
 * Vulnerability severity levels.
 */
export type Severity = 'critical' | 'high' | 'medium' | 'low' | 'unknown';

/**
 * Severity ordering for comparison.
 */
export const SeverityOrder: Record<Severity, number> = {
  critical: 4,
  high: 3,
  medium: 2,
  low: 1,
  unknown: 0,
};

/**
 * Compares two severities.
 * Returns > 0 if a is more severe, < 0 if b is more severe, 0 if equal.
 */
export function compareSeverity(a: Severity, b: Severity): number {
  return SeverityOrder[a] - SeverityOrder[b];
}

/**
 * Checks if a severity meets or exceeds a threshold.
 */
export function meetsThreshold(severity: Severity, threshold: Severity): boolean {
  return SeverityOrder[severity] >= SeverityOrder[threshold];
}

/**
 * CVSS (Common Vulnerability Scoring System) details.
 */
export interface CvssDetails {
  /** CVSS score (0.0 - 10.0) */
  readonly score: number;
  /** CVSS version */
  readonly version: string;
  /** Attack vector */
  readonly attackVector?: string;
  /** Attack complexity */
  readonly attackComplexity?: string;
  /** Privileges required */
  readonly privilegesRequired?: string;
  /** User interaction */
  readonly userInteraction?: string;
  /** Scope */
  readonly scope?: string;
  /** Confidentiality impact */
  readonly confidentialityImpact?: string;
  /** Integrity impact */
  readonly integrityImpact?: string;
  /** Availability impact */
  readonly availabilityImpact?: string;
}

/**
 * Vulnerability information.
 */
export interface Vulnerability {
  /** Vulnerability ID (CVE, GHSA, etc.) */
  readonly id: string;
  /** Severity level */
  readonly severity: Severity;
  /** Short summary */
  readonly summary: string;
  /** Detailed description */
  readonly description?: string;
  /** Fixed in version (if available) */
  readonly fixedIn?: string;
  /** Package name affected */
  readonly packageName?: string;
  /** Current installed version */
  readonly installedVersion?: string;
  /** CVSS details */
  readonly cvss?: CvssDetails;
  /** Reference URLs */
  readonly references: readonly string[];
  /** Publication date */
  readonly publishedAt?: string;
  /** Last modified date */
  readonly updatedAt?: string;
}

/**
 * Vulnerability report for a package version.
 */
export interface VulnerabilityReport {
  /** Package version ID */
  readonly packageVersionId: number;
  /** List of vulnerabilities */
  readonly vulnerabilities: readonly Vulnerability[];
  /** Scan timestamp */
  readonly scannedAt: string;
  /** Scan status */
  readonly status: 'completed' | 'pending' | 'failed' | 'unavailable';
  /** Error message (if status is 'failed') */
  readonly error?: string;
}

/**
 * Vulnerable version summary.
 */
export interface VulnerableVersion {
  /** Package version ID */
  readonly versionId: number;
  /** Tags associated with this version */
  readonly tags: readonly string[];
  /** Vulnerabilities found */
  readonly vulnerabilities: readonly Vulnerability[];
  /** Highest severity found */
  readonly highestSeverity: Severity;
  /** Total vulnerability count */
  readonly count: number;
}

/**
 * Vulnerability report utilities.
 */
export const VulnerabilityReportUtils = {
  /**
   * Creates an empty report (no vulnerabilities).
   */
  empty(packageVersionId: number): VulnerabilityReport {
    return {
      packageVersionId,
      vulnerabilities: [],
      scannedAt: new Date().toISOString(),
      status: 'completed',
    };
  },

  /**
   * Creates an unavailable report (GHAS not enabled).
   */
  unavailable(packageVersionId: number): VulnerabilityReport {
    return {
      packageVersionId,
      vulnerabilities: [],
      scannedAt: new Date().toISOString(),
      status: 'unavailable',
    };
  },

  /**
   * Gets the highest severity from a report.
   */
  highestSeverity(report: VulnerabilityReport): Severity {
    if (report.vulnerabilities.length === 0) {
      return 'unknown';
    }

    return report.vulnerabilities.reduce((highest, vuln) =>
      compareSeverity(vuln.severity, highest) > 0 ? vuln.severity : highest,
      'unknown' as Severity
    );
  },

  /**
   * Filters vulnerabilities by minimum severity.
   */
  filterBySeverity(
    report: VulnerabilityReport,
    minSeverity: Severity
  ): Vulnerability[] {
    return report.vulnerabilities.filter(v =>
      meetsThreshold(v.severity, minSeverity)
    );
  },

  /**
   * Groups vulnerabilities by severity.
   */
  groupBySeverity(
    report: VulnerabilityReport
  ): Record<Severity, Vulnerability[]> {
    const groups: Record<Severity, Vulnerability[]> = {
      critical: [],
      high: [],
      medium: [],
      low: [],
      unknown: [],
    };

    for (const vuln of report.vulnerabilities) {
      groups[vuln.severity].push(vuln);
    }

    return groups;
  },

  /**
   * Counts vulnerabilities by severity.
   */
  countBySeverity(report: VulnerabilityReport): Record<Severity, number> {
    const counts: Record<Severity, number> = {
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
      unknown: 0,
    };

    for (const vuln of report.vulnerabilities) {
      counts[vuln.severity]++;
    }

    return counts;
  },

  /**
   * Checks if the report has any vulnerabilities meeting a threshold.
   */
  hasVulnerabilitiesAbove(
    report: VulnerabilityReport,
    threshold: Severity
  ): boolean {
    return report.vulnerabilities.some(v =>
      meetsThreshold(v.severity, threshold)
    );
  },

  /**
   * Gets vulnerabilities with available fixes.
   */
  fixableVulnerabilities(report: VulnerabilityReport): Vulnerability[] {
    return report.vulnerabilities.filter(v => v.fixedIn !== undefined);
  },

  /**
   * Creates a VulnerableVersion from a report and package info.
   */
  toVulnerableVersion(
    report: VulnerabilityReport,
    tags: string[]
  ): VulnerableVersion {
    return {
      versionId: report.packageVersionId,
      tags,
      vulnerabilities: report.vulnerabilities,
      highestSeverity: VulnerabilityReportUtils.highestSeverity(report),
      count: report.vulnerabilities.length,
    };
  },
};
